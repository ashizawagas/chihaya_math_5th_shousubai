<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 5Âπ¥ÁîüÂ∞èÊï∞„ÅÆÂÄçÁâà</title>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // FirebaseË®≠ÂÆö
    const firebaseConfig = {
        apiKey: "AIzaSyD8iHtx_7h9q2LeNgz3X4TmRjvqgrGo8EQ",
        authDomain: "nen-shousu.firebaseapp.com",
        projectId: "nen-shousu",
        storageBucket: "nen-shousu.firebasestorage.app",
        messagingSenderId: "856032037557",
        appId: "1:856032037557:web:c5730907d70d88a7874cfc",
        measurementId: "G-QKQDLRWBX3"
    };

    // Firebase„ÅÆÂàùÊúüÂåñ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
    window.db = db;
    window.firestore = { collection, doc, setDoc, getDocs, query, orderBy, limit, serverTimestamp, getDoc };
    
    console.log('FirebaseÂàùÊúüÂåñÂÆå‰∫Ü');
</script>

<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1) rotate(0deg);color:#333}20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}}
@keyframes correct{0%{transform:scale(1);color:#333}25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
button:disabled{background:#ccc;cursor:not-allowed}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.mode-btn.formula{background:#e91e63}
.mode-btn.formula:hover{background:#c2185b}
.mode-btn.hidden{background:#ff6b6b;animation:hiddenPulse 2s infinite}
.mode-btn.hidden:hover{background:#d32f2f}
@keyframes hiddenPulse{0%,100%{transform:scale(1);box-shadow:0 0 10px #ff6b6b}50%{transform:scale(1.05);box-shadow:0 0 20px #ff6b6b}}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
input:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.progress-bar.formula{background:#e91e63}
.progress-bar.hidden{background:linear-gradient(45deg,#ff6b6b,#ffd700,#4caf50,#2196f3);background-size:400% 400%;animation:hiddenProgress 3s ease infinite}
@keyframes hiddenProgress{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.mode-info.formula{background:#fce4ec;color:#c2185b;border:2px solid #e91e63}
.mode-info.hidden{background:linear-gradient(45deg,#ffebee,#fff3e0,#e8f5e8,#e3f2fd);color:#d32f2f;border:2px solid #ff6b6b;animation:hiddenGlow 2s infinite}
@keyframes hiddenGlow{0%,100%{box-shadow:0 0 10px rgba(255,107,107,0.3)}50%{box-shadow:0 0 20px rgba(255,107,107,0.6)}}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
@keyframes rainbow{0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:300px;margin:20px auto}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.normal-input{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0}
.normal-input input{width:150px;text-align:center}
.formula-input{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.formula-input input{width:100px;text-align:center;font-size:16px}
.formula-input select{width:80px;text-align:center;font-size:16px;padding:8px;border:2px solid #ddd;border-radius:5px}
.formula-input select:focus{border-color:#e91e63;outline:none;box-shadow:0 0 5px rgba(233,30,99,.3)}
.formula-input select:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
.unit-display{font-size:16px;font-weight:bold;color:#666;margin-left:10px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.submit-btn:disabled{background:#ccc;cursor:not-allowed}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.level-select{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s;position:relative}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.level-btn.cleared{background:linear-gradient(45deg,#ffd700,#ffed4e);border:3px solid #ff6b6b;animation:clearedGlow 2s infinite}
.level-btn.cleared::after{content:'üèÜ‚ú®';position:absolute;top:-10px;right:-10px;font-size:20px;animation:bounce 1s infinite}
@keyframes clearedGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.correct-celebration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#ff0,#f00);border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{0%{transform:scale(1);opacity:1}100%{transform:scale(20);opacity:0}}
.sparkle{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:sparkle 1.5s ease-out infinite}
@keyframes sparkle{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.nav-btn{background:#6c757d;color:white;padding:8px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
.nav-btn:hover{background:#5a6268}
.timer{font-size:20px;font-weight:bold;color:#d32f2f;margin:10px 0;padding:10px;background:white;border-radius:8px;border:2px solid #f44336}
.ranking{background:white;border-radius:10px;padding:20px;margin:20px 0;border:2px solid #ffd700}
.ranking h3{color:#d32f2f;margin-bottom:15px}
.ranking-item{display:flex;justify-content:space-between;align-items:center;padding:8px 15px;margin:5px 0;border-radius:5px;background:#f8f9fa}
.ranking-item.current{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.ranking-item.top3{background:#fff3cd;border:2px solid #ffc107}
.rank-medal{font-size:20px;margin-right:10px}
@keyframes titleGlow{0%,100%{transform:scale(1);box-shadow:0 0 20px #ffd700}50%{transform:scale(1.05);box-shadow:0 0 40px #ffd700,0 0 60px #ff6b6b}}
@keyframes masterCelebration{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.5) rotate(90deg);filter:hue-rotate(90deg)}50%{transform:scale(2) rotate(180deg);filter:hue-rotate(180deg)}75%{transform:scale(1.5) rotate(270deg);filter:hue-rotate(270deg)}100%{transform:scale(1) rotate(360deg);filter:hue-rotate(360deg)}}
.master-celebration{animation:masterCelebration 4s ease-in-out}
.hidden-stage-unlock{background:linear-gradient(45deg,#ff6b6b,#ffd700);color:white;font-weight:bold;animation:hiddenUnlock 3s infinite}
@keyframes hiddenUnlock{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(255,107,107,0.5)}50%{transform:scale(1.1);box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-display{background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:15px;border-radius:10px;margin:15px 0;border:3px solid #ff6b6b;font-weight:bold;font-size:18px;animation:pointsGlow 2s infinite}
@keyframes pointsGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-earned{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50;font-weight:bold;animation:pointsEarn 2s}
@keyframes pointsEarn{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.session-points{background:#e3f2fd;color:#1976d2;padding:8px;border-radius:6px;margin:5px 0;border:1px solid #2196f3;font-size:14px}
.player-id{background:#f3e5f5;color:#7b1fa2;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #9c27b0;font-size:14px;font-weight:bold}
.global-ranking{background:#fff3cd;border-radius:10px;padding:20px;margin:20px 0;border:2px solid #ffc107}
.global-ranking h3{color:#f57c00;margin-bottom:15px}
.global-ranking-item{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;margin:5px 0;border-radius:5px;background:#fff8e1}
.global-ranking-item.my-rank{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.level-clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
.formula-hint{background:#fff3e0;color:#f57c00;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #ff9800;font-size:14px}

/* „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
.bonus-game-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000;
    display: none;
    overflow: auto;
}

.bonus-game-container.active {
    display: block;
}

.bonus-game-content {
    width: 100%;
    height: 100%;
    position: relative;
}

/* „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†ÂÜÖ„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÂÄçÊï∞„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞Áî®Ôºâ */
.bonus-game-content * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.bonus-game-content body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
    background-size: 400% 400%;
    animation: gradientShift 8s ease infinite;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow-x: hidden;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.bonus-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 30px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    text-align: center;
    max-width: 600px;
    width: 90%;
    position: relative;
    overflow: hidden;
    margin: 20px auto;
}

.bonus-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shine 3s linear infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.bonus-container h1 {
    color: #ff6b6b;
    font-size: 2.5em;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.bonus-roulette-setup, .bonus-game-setup, .bonus-shooting-game, .bonus-game-over {
    display: none;
}

.bonus-roulette-setup.active, .bonus-game-setup.active, .bonus-shooting-game.active, .bonus-game-over.active {
    display: block;
}

.bonus-setup-description {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    border-left: 5px solid #4ecdc4;
}

.bonus-setup-description h3 {
    color: #333;
    margin-bottom: 10px;
}

.bonus-setup-description p {
    color: #666;
    font-size: 1em;
    line-height: 1.5;
}

.bonus-roulette-container {
    background: linear-gradient(45deg, #feca57, #ff9ff3);
    border-radius: 20px;
    padding: 30px;
    margin: 20px 0;
    color: white;
}

.bonus-roulette-wheel {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    border: 8px solid white;
    margin: 20px auto;
    position: relative;
    background: conic-gradient(
        #ff6b6b 0deg 45deg,
        #4ecdc4 45deg 90deg,
        #45b7d1 90deg 135deg,
        #96ceb4 135deg 180deg,
        #feca57 180deg 225deg,
        #ff9ff3 225deg 270deg,
        #ff6b6b 270deg 315deg,
        #4ecdc4 315deg 360deg
    );
    transition: transform 1.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.bonus-roulette-pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 20px solid #333;
}

.bonus-roulette-numbers {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5em;
    font-weight: bold;
    color: white;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.bonus-target-info {
    background: linear-gradient(45deg, #feca57, #ff9ff3);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    font-size: 1.5em;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.bonus-roulette-btn, .bonus-start-game-btn {
    background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
    color: white;
    border: none;
    padding: 25px 50px;
    margin: 20px;
    border-radius: 30px;
    font-size: 1.5em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    animation: pulse 2s ease-in-out infinite;
}

.bonus-roulette-btn:hover, .bonus-start-game-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 15px 30px rgba(0,0,0,0.4);
    background: linear-gradient(45deg, #ff8e8e, #ffb3b3);
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.bonus-shooting-area {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(to bottom, #87ceeb, #98fb98);
    border-radius: 15px;
    overflow: hidden;
    margin: 20px 0;
}

.bonus-player {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: #ff6b6b;
    border-radius: 50%;
    cursor: pointer;
    transition: left 0.1s ease;
}

.bonus-falling-number {
    position: absolute;
    width: 50px;
    height: 50px;
    background: linear-gradient(45deg, #4ecdc4, #45b7d1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    font-size: 1.2em;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.bonus-bullet {
    position: absolute;
    width: 8px;
    height: 15px;
    background: #ff6b6b;
    border-radius: 4px;
}

.bonus-score {
    font-size: 1.5em;
    color: #333;
    margin: 10px 0;
    font-weight: bold;
}

.bonus-timer {
    font-size: 1.3em;
    color: #ff6b6b;
    margin: 10px 0;
    font-weight: bold;
}

.bonus-game-instructions {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 15px;
    margin: 15px 0;
    border: 2px solid #4ecdc4;
    font-size: 1em;
    color: #333;
    line-height: 1.4;
}

.bonus-controls-info {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
    font-size: 0.9em;
    color: #666;
}

.bonus-game-over-content {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    margin: 20px 0;
    border: 3px solid #ff6b6b;
    animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.3); }
    50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.6); }
}

.bonus-final-score {
    font-size: 2em;
    color: #ff6b6b;
    margin: 20px 0;
    font-weight: bold;
}

.bonus-achievements {
    background: linear-gradient(45deg, #feca57, #ff9ff3);
    color: white;
    padding: 15px;
    border-radius: 15px;
    margin: 15px 0;
    font-weight: bold;
}

.bonus-back-btn {
    background: linear-gradient(45deg, #95a5a6, #bdc3c7);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 15px;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
    font-size: 1.1em;
}

.bonus-back-btn:hover {
    transform: scale(1.1);
}

.bonus-stars {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

.bonus-star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle 2s ease-in-out infinite;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

.level-up-message {
    background: linear-gradient(45deg, #4CAF50, #81C784);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    font-size: 1.2em;
    font-weight: bold;
    text-align: center;
    animation: levelUpGlow 2s infinite;
}

@keyframes levelUpGlow {
    0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
    50% { box-shadow: 0 0 30px rgba(76, 175, 80, 0.8); }
}
</style>
</head>
<body>
<h1>üßÆ ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 5Âπ¥ÁîüÂ∞èÊï∞„ÅÆÂÄçÁâà</h1>

<div id="start">
<h2>„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div id="playerIdDisplay" class="player-id" style="display:none">üë§ „Éó„É¨„Ç§„É§„ÉºID: <span id="playerId"></span></div>
<div id="pointsDisplay" class="points-display" style="display:none">üí∞ Á∑è„Éù„Ç§„É≥„Éà: <span id="totalPoints">0</span>P</div>
<div class="info">
<div class="mode-info select"><h3>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</h3><p>‚Ä¢ Â•Ω„Åç„Å™„É¨„Éô„É´„ÇíÈÅ∏„Çì„ÅßÁ∑¥Áøí<br>‚Ä¢ 10ÂïèÈÄ£Á∂öÊ≠£Ëß£„Åß„É¨„Éô„É´„ÇØ„É™„Ç¢<br>‚Ä¢ Ê≠£Ëß£„Åß„Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºàÂ∞ë„Å™„ÇÅÔºâ</p></div>
<div class="mode-info formula"><h3>üìù Âºè„Å†„Åë„É¢„Éº„Éâ</h3><p>‚Ä¢ Á´ãÂºè„ÅÆÁ∑¥Áøí„Å´ÁâπÂåñ<br>‚Ä¢ Ë®àÁÆóÁµêÊûú„Åß„ÅØ„Å™„ÅèÂºè„ÇíÂÖ•Âäõ<br>‚Ä¢ Êï∞Â≠¶ÁöÑÊÄùËÄÉÂäõ„ÇíÈçõ„Åà„Çã</p></div>
<div class="mode-info practice"><h3>üìö Á∑¥Áøí„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂêÑ„É¨„Éô„É´„Åß5ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊ¨°„ÅÆ„É¨„Éô„É´„Å∏<br>‚Ä¢ ÈñìÈÅï„Åà„Åü„Çâ„Åù„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çã<br>‚Ä¢ „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åß„Éú„Éº„Éä„Çπ„Éù„Ç§„É≥„ÉàÔºà‰∏≠Á®ãÂ∫¶Ôºâ</p></div>
<div class="mode-info summary"><h3>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂÖ®5„É¨„Éô„É´√óÂêÑ5ÂïèÔºùË®à25Âïè„Å´ÊåëÊà¶<br>‚Ä¢ ‰∏ÄÂïè„Åß„ÇÇÈñìÈÅï„Åà„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº<br>‚Ä¢ „ÇØ„É™„Ç¢ÊôÇÈñì„Å´Âøú„Åò„Å¶Â§ßÈáè„Éù„Ç§„É≥„ÉàÁç≤Âæó<br>‚Ä¢ <strong>ÂêÑ„É¨„Éô„É´„ÇØ„É™„Ç¢„Åß„Éú„Éº„Éä„Çπ„Ç≤„Éº„É†ÔºÅ</strong><br>‚Ä¢ <strong>„ÇØ„É™„Ç¢„ÅßÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏Ëß£ÊîæÔºÅ</strong></p></div>
<div id="hiddenModeInfo" class="mode-info hidden" style="display:none"><h3>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</h3><p>‚Ä¢ Ë∂ÖÈ´òÈõ£Â∫¶„ÅÆÂ∞èÊï∞„ÅÆÂÄçÂïèÈ°å„Å´ÊåëÊà¶<br>‚Ä¢ ÂÖ®10Âïè„ÇØ„É™„Ç¢„Åß„ÄåÂ∞èÊï∞„ÅÆÂÄç„Éû„Çπ„Çø„Éº„Äç„ÅÆÁß∞Âè∑Áç≤Âæó<br>‚Ä¢ Ê¥æÊâã„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÁ•ùÁ¶èÔºÅ</p></div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</button>
<button class="mode-btn formula" onclick="showFormulaLevelSelect()">üìù Âºè„Å†„Åë„É¢„Éº„Éâ</button>
<button class="mode-btn practice" onclick="selectMode('practice')">üìö Á∑¥Áøí„É¢„Éº„Éâ</button>
<button class="mode-btn" onclick="selectMode('summary')">üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</button>
<button id="hiddenStageBtn" class="mode-btn hidden" onclick="selectMode('hidden')" style="display:none">üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</button>
<div style="margin-top: 20px;">
    <button onclick="displayFirebaseRanking()">üåç „Ç∞„É≠„Éº„Éê„É´„É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫</button>
</div>
</div>

<div id="levelSelect" style="display:none">
<h2>üéÆ „É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)"><h4>‚úñÔ∏è „É¨„Éô„É´1</h4><p>‰ΩïÂÄç„Åã</p></div>
<div class="level-btn" onclick="selectLevel(2)"><h4>üìè „É¨„Éô„É´2</h4><p>„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï</p></div>
<div class="level-btn" onclick="selectLevel(3)"><h4>‚ú® „É¨„Éô„É´3</h4><p>Â∞èÊï∞ÂÄç„Åó„ÅüÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(4)"><h4>üî¢ „É¨„Éô„É´4</h4><p>„ÇÇ„Å®„ÅÆ‰ΩïÂÄç„Åã</p></div>
<div class="level-btn" onclick="selectLevel(5)"><h4>üéØ „É¨„Éô„É´5</h4><p>„ÅÑ„Çç„ÅÑ„Çç„Å™ÂïèÈ°å</p></div>
</div>
<button onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
</div>

<div id="formulaLevelSelect" style="display:none">
<h2>üìù Âºè„Å†„Åë„É¢„Éº„Éâ - „É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="level-select">
<div class="level-btn" onclick="selectFormulaLevel(1)"><h4>‚úñÔ∏è „É¨„Éô„É´1</h4><p>‰ΩïÂÄç„Åã</p></div>
<div class="level-btn" onclick="selectFormulaLevel(2)"><h4>üìè „É¨„Éô„É´2</h4><p>„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï</p></div>
<div class="level-btn" onclick="selectFormulaLevel(3)"><h4>‚ú® „É¨„Éô„É´3</h4><p>Â∞èÊï∞ÂÄç„Åó„ÅüÊï∞</p></div>
<div class="level-btn" onclick="selectFormulaLevel(4)"><h4>üî¢ „É¨„Éô„É´4</h4><p>„ÇÇ„Å®„ÅÆ‰ΩïÂÄç„Åã</p></div>
<div class="level-btn" onclick="selectFormulaLevel(5)"><h4>üéØ „É¨„Éô„É´5</h4><p>„ÅÑ„Çç„ÅÑ„Çç„Å™ÂïèÈ°å</p></div>
</div>
<button onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>„É¨„Éô„É´<span id="lv">1</span>/5 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
<div id="sessionPoints" class="session-points" style="display:none">‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥: <span id="sessionPointsValue">0</span>P</div>
</div>

<div id="timerDisplay" class="timer" style="display:none">‚è±Ô∏è ÁµåÈÅéÊôÇÈñì: <span id="timer">00:00</span></div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
<button class="nav-btn" id="formulaLevelSelectBtn" onclick="backToFormulaLevelSelect()" style="display:none">Âºè„Å†„Åë„É¢„Éº„ÉâÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">‚úñÔ∏è</div>
<div class="question" id="q"></div>

<div class="answer-section">
<h3 id="answerTitle">Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
<div class="normal-input" id="normalInput">
<input type="text" id="norm" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<div class="formula-input" id="formulaInput" style="display:none">
<input type="number" id="num1" placeholder="Êï∞ÂÄ§" step="0.01">
<select id="operator">
<option value="">ÊºîÁÆóÂ≠ê</option>
<option value="√∑">√∑</option>
<option value="√ó">√ó</option>
<option value="+">+</option>
<option value="-">-</option>
</select>
<input type="number" id="num2" placeholder="Êï∞ÂÄ§" step="0.01">
</div>
<div id="formulaHint" class="formula-hint" style="display:none">
üí° „Éí„É≥„Éà: Â∑¶„ÅÆÊ¨Ñ„Å´Êï∞ÂÄ§„ÄÅÁúü„Çì‰∏≠„ÅßÊºîÁÆóÂ≠ê„ÇíÈÅ∏Êäû„ÄÅÂè≥„ÅÆÊ¨Ñ„Å´Êï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
</div>
<button class="submit-btn" onclick="submitAnswer()">Á≠î„Åà„Çã</button>
</div>

<div id="wrong" style="display:none">
<div id="wrongMsg" class="error-msg">„Åæ„Å°„Åå„ÅÑ„Åß„Åô„ÄÇ</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>Ê≠£Ëß£Ôºö</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>„Åì„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇÈ†ëÂºµ„Å£„Å¶ÔºÅ</p></div>
<div id="selectMsg" style="display:none"><p>ÈÄ£Á∂öÊ≠£Ëß£„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>
<div id="formulaMsg" style="display:none"><p>ÈÄ£Á∂öÊ≠£Ëß£„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇÁ´ãÂºè„ÇíË¶ãÁõ¥„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>
<button onclick="retry()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
<button onclick="next()">„Å§„Åé„Å∏</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
<button id="backToFormulaSelectBtn" onclick="backToFormulaLevelSelect()" style="display:none">Âºè„Å†„Åë„É¢„Éº„ÉâÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div class="status">
<span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 25Âïè‰∏≠</span>
<span id="hiddenQ" style="display:none"> / 10Âïè‰∏≠</span>
<span id="selectQ" style="display:none"> / 10Âïè‰∏≠</span>
<span id="formulaQ" style="display:none"> / 10Âïè‰∏≠</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
<div class="monster" style="font-size:120px">üòµ</div>
<h2>ÊÆãÂøµÔºÅ</h2>
<div class="info">
<p>Âà∞ÈÅî„É¨„Éô„É´: <span id="finalLv"></span>/5</p>
<p>Ê≠£Ëß£Êï∞: <span id="finalScore1"></span>Âïè</p>
<p id="finalTime" style="display:none">ÁµåÈÅéÊôÇÈñì: <span id="finalTimeValue"></span></p>
<div id="gameoverPoints" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="gameoverPointsValue">0</span>P</div>
</div>
<div id="globalRankingGameover" class="global-ranking">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListGameover"></div>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üëë</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÂÖ®„É¨„Éô„É´Âà∂Ë¶áÔºÅ</h2>
<div class="info">
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore2"></span>ÂïèÊ≠£Ëß£</p>
<p id="clearTime">„ÇØ„É™„Ç¢ÊôÇÈñì: <span id="clearTimeValue"></span></p>
<div id="pointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="earnedPoints">0</span>P</div>
</div>
<div id="globalRankingClear" class="global-ranking" style="display:none">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListClear"></div>
</div>
<div id="hiddenStageUnlock" class="hidden-stage-unlock" style="display:none;padding:20px;margin:20px;border-radius:15px;">
<h3>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅåËß£Êîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ üåü</h3>
<p>‰ªä„Åô„ÅêÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏„Å´ÊåëÊà¶„Åß„Åç„Åæ„ÅôÔºÅ</p>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="levelClear" style="display:none" class="level-clear-screen">
<h1>üéâ „É¨„Éô„É´„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üèÜ</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ„É¨„Éô„É´<span id="clearedLevel"></span>„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ</h2>
<div class="info">
<p>10ÂïèÈÄ£Á∂öÊ≠£Ëß£ÈÅîÊàêÔºÅ</p>
<div id="levelClearPoints" class="points-earned">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="levelClearPointsValue">0</span>P</div>
</div>
<button onclick="backToLevelSelect()">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
<button id="backToFormulaSelectFromClear" onclick="backToFormulaLevelSelect()" style="display:none">Âºè„Å†„Åë„É¢„Éº„ÉâÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div id="hiddenClear" style="display:none">
<div style="background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);padding:40px;border-radius:20px;animation:rainbow 3s infinite;">
<h1>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üåü</h1>
<div class="monster master-celebration" style="font-size:150px;">üëë</div>
<h2>üèÜ Â∞èÊï∞„ÅÆÂÄç„Éû„Çπ„Çø„ÉºË™ïÁîüÔºÅ üèÜ</h2>
<p style="font-size:20px;color:#d32f2f;font-weight:bold;">„ÅÇ„Å™„Åü„ÅØÁúü„ÅÆÂ∞èÊï∞„ÅÆÂÄç„ÅÆÈÅî‰∫∫„Åß„ÅôÔºÅ</p>
<div style="margin:20px 0;font-size:18px;">
<p>Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏ÂÖ®10ÂïèÂÆåÂÖ®Âà∂Ë¶á</p>
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="hiddenFinalScore"></span>ÂïèÊ≠£Ëß£</p>
<div id="hiddenPointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="hiddenEarnedPoints">0</span>P</div>
</div>
<div id="globalRankingHidden" class="global-ranking" style="display:none">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListHidden"></div>
</div>
<button onclick="restart()" style="padding:15px 30px;font-size:20px;background:#4CAF50;color:white;border:none;border-radius:10px;cursor:pointer;">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
</div>
</div>

<div id="celebration" class="correct-celebration"></div>

<!-- ÊâãÊõ∏„ÅçË®àÁÆó„Çπ„Éö„Éº„ÇπÔºàÂ∏∏ÊôÇË°®Á§∫Ôºâ -->
<div id="handwritingSpace" style="margin-top:40px;padding:20px;background:#f0f8ff;border-radius:15px;border:3px solid #2196f3">
<div class="info">
<h2 style="color:#2196f3;margin:0 0 15px 0">üìù ÊâãÊõ∏„ÅçË®àÁÆó„Çπ„Éö„Éº„Çπ</h2>
<p style="margin:0 0 15px 0;color:#666">„Éû„Ç¶„Çπ„ÇÑÊåá„ÅßËá™Áî±„Å´Ë®àÁÆóÂºè„ÇÑÂõ≥„ÇíÊõ∏„Åë„Åæ„Åô</p>
</div>
<div style="background:white;border-radius:10px;padding:20px;border:2px solid #2196f3">
<!-- „ÇØ„É™„Ç¢„Éú„Çø„É≥„Çí‰∏äÈÉ®„Å´ÁßªÂãï -->
<div style="margin-bottom:15px;text-align:center">
<button onclick="clearDrawCanvas()" style="background:#ff9800;color:white;border:none;padding:10px 20px;border-radius:6px;margin:5px;cursor:pointer;font-size:14px">üóëÔ∏è „ÇØ„É™„Ç¢</button>
</div>
<canvas id="drawArea" width="1600" height="1600" style="border:2px solid #2196f3;border-radius:8px;background:#fff;touch-action:none;display:block;margin:0 auto;cursor:crosshair"></canvas>
<div style="font-size:14px;color:#666;margin-top:15px;text-align:center;background:#f8f9fa;padding:10px;border-radius:6px">
üí° „Éí„É≥„Éà: Á≠ÜÁÆó„ÇÑÂõ≥„ÇíÊèè„ÅÑ„Å¶ÂïèÈ°å„ÇíËß£„ÅÑ„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅÂ∞èÊï∞„ÅÆ‰ΩçÂèñ„Çä„ÇÑË®àÁÆóÈÅéÁ®ã„ÇíÊõ∏„Åè„Å®ÁêÜËß£„ÅåÊ∑±„Åæ„Çä„Åæ„Åô„ÄÇ
</div>
</div>
</div>

<!-- „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†Áî®„ÅÆ„Ç≥„É≥„ÉÜ„Éä -->
<div id="bonusGameContainer" class="bonus-game-container">
    <div class="bonus-game-content">
        <div class="bonus-stars" id="bonusStars"></div>
        
        <div class="bonus-container">
            <h1>üéØ „Éú„Éº„Éä„Çπ„Ç≤„Éº„É† - ÂÄçÊï∞„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞ üéØ</h1>
            
            <!-- „É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢ -->
            <div class="bonus-roulette-setup active" id="bonusRouletteSetup">
                <div class="bonus-setup-description">
                    <h3>üé≤ „É´„Éº„É¨„ÉÉ„Éà„ÅßÂÄçÊï∞„ÇíÊ±∫„ÇÅ„Çà„ÅÜÔºÅ</h3>
                    <p>„É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„Åó„Å¶„ÄÅ‰ªäÂõû„ÅÆ„Ç≤„Éº„É†„ÅßÁãô„ÅÜÂÄçÊï∞„ÇíÊ±∫ÂÆö„Åó„Åæ„Åô„ÄÇ<br>
                    Ê±∫ÂÆö„Åó„ÅüÂÄçÊï∞„ÇíÊíÉ„Å£„Å¶È´òÂæóÁÇπ„ÇíÁãô„Åä„ÅÜÔºÅ</p>
                </div>
                
                <div class="bonus-roulette-container">
                    <div class="bonus-roulette-pointer"></div>
                    <div class="bonus-roulette-wheel" id="bonusRouletteWheel">
                        <div class="bonus-roulette-numbers">2-9</div>
                    </div>
                    <button class="bonus-roulette-btn" id="bonusSpinBtn" onclick="bonusSpinRoulette()">
                        üé≤ „É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„ÅôÔºÅ
                    </button>
                </div>
            </div>

            <!-- „Ç≤„Éº„É†Ë®≠ÂÆöÁîªÈù¢ -->
            <div class="bonus-game-setup" id="bonusGameSetup">
                <div class="bonus-setup-description">
                    <h3>üéÆ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ</h3>
                    <p>Ê±∫ÂÆö„Åó„ÅüÂÄçÊï∞„ÇíÊíÉ„Å£„Å¶È´òÂæóÁÇπ„ÇíÁãô„Åä„ÅÜÔºÅ<br>
                    <strong>Ê≠£Ëß£ÔºàÂÄçÊï∞ÔºâÔºö+10ÁÇπ</strong><br>
                    <strong>‰∏çÊ≠£Ëß£Ôºö-5ÁÇπ</strong><br>
                    Âà∂ÈôêÊôÇÈñì„ÅØ30Áßí„Åß„ÄÅÁ¥Ñ60ÂÄã„ÅÆÊï∞Â≠ó„ÅåËêΩ„Å°„Å¶„Åç„Åæ„ÅôÔºÅ<br>
                    „Åù„ÅÆ‰∏≠„ÅßÁõÆÊ®ô„ÅÆÂÄçÊï∞„ÅØ20ÂÄãËêΩ„Å°„Å¶„Åç„Åæ„ÅôÔºÅ</p>
                </div>
                
                <div class="bonus-target-info" id="bonusTargetInfo">
                    ÁõÆÊ®ô„ÅÆÂÄçÊï∞: ?„ÅÆÂÄçÊï∞
                </div>
                
                <button class="bonus-start-game-btn" onclick="bonusStartGame()">
                    üöÄ „Ç≤„Éº„É†ÈñãÂßãÔºÅ
                </button>
            </div>

            <!-- „Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≤„Éº„É† -->
            <div class="bonus-shooting-game" id="bonusShootingGame">
                <h2>üéØ ÂÄçÊï∞„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞ÔºÅ</h2>
                <div class="bonus-game-instructions" id="bonusGameInstructions">
                    <strong>?„ÅÆÂÄçÊï∞„ÇíÊíÉ„Å¶ÔºÅ</strong>
                </div>
                <div class="bonus-controls-info">
                    ÁßªÂãï: ‚Üê‚Üí„Ç≠„Éº „Åæ„Åü„ÅØ „Çø„ÉÉ„ÉÅ | Áô∫Â∞Ñ: „Çπ„Éö„Éº„Çπ „Åæ„Åü„ÅØ „Ç®„É≥„Çø„Éº
                </div>
                <div class="bonus-timer" id="bonusGameTimer">ÊÆã„ÇäÊôÇÈñì: 30Áßí</div>
                <div class="bonus-score" id="bonusGameScore">„Çπ„Ç≥„Ç¢: 0</div>
                <div class="bonus-shooting-area" id="bonusShootingArea">
                    <div class="bonus-player" id="bonusPlayer"></div>
                </div>
                <button class="bonus-back-btn" onclick="bonusGoHome()">üè† „Éõ„Éº„É†„Å´Êàª„Çã</button>
            </div>

                     <!-- „Ç≤„Éº„É†ÁµÇ‰∫ÜÁîªÈù¢ -->
            <div class="bonus-game-over" id="bonusGameOver">
                <div class="bonus-game-over-content">
                    <h2>üéâ „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
                    <div class="bonus-final-score" id="bonusFinalScore">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: 0</div>
                    <div class="bonus-achievements" id="bonusAchievements">
                        <!-- ÈÅîÊàêÂÜÖÂÆπ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    <div class="level-up-message">
                        <p>üéâ „Éú„Éº„Éä„Çπ„Éù„Ç§„É≥„Éà„ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ üéâ</p>
                        <p>Ê¨°„ÅÆ„É¨„Éô„É´„Å´ÈÄ≤„Åø„Åæ„ÅôÔºÅ</p>
                    </div>
                    <button class="bonus-start-game-btn" onclick="bonusReturnToMainGame()">Ê¨°„ÅÆ„É¨„Éô„É´„Å∏ÈÄ≤„ÇÄ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// FirebaseÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
async function savePlayerScore(playerId, points) {
    try {
        const playerRef = window.firestore.doc(window.db, 'players', playerId);
        
        const docSnap = await window.firestore.getDoc(playerRef);
        let shouldUpdate = true;
        
        if (docSnap.exists()) {
            const existingPoints = docSnap.data().totalPoints || 0;
            shouldUpdate = points > existingPoints;
        }
        
        if (shouldUpdate) {
            await window.firestore.setDoc(playerRef, {
                playerId: playerId,
                totalPoints: points,
                lastUpdate: window.firestore.serverTimestamp()
            }, { merge: true });
            
            console.log('„Çπ„Ç≥„Ç¢„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü:', points);
            return true;
        } else {
            console.log('Êó¢Â≠ò„ÅÆ„Çπ„Ç≥„Ç¢„ÅÆÊñπ„ÅåÈ´ò„ÅÑ„Åü„ÇÅÊõ¥Êñ∞„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü');
            return false;
        }
    } catch (error) {
        console.error('„Çπ„Ç≥„Ç¢‰øùÂ≠ò„Ç®„É©„Éº:', error);
        return false;
    }
}

async function fetchTopRanking(limitCount = 10) {
    try {
        const rankingQuery = window.firestore.query(
            window.firestore.collection(window.db, 'players'),
            window.firestore.orderBy('totalPoints', 'desc'),
            window.firestore.limit(limitCount)
        );
        
        const querySnapshot = await window.firestore.getDocs(rankingQuery);
        const rankings = [];
        
        querySnapshot.forEach((doc, index) => {
            const data = doc.data();
            rankings.push({
                rank: index + 1,
                playerId: data.playerId,
                totalPoints: data.totalPoints,
                lastUpdate: data.lastUpdate
            });
        });
        
        return rankings;
    } catch (error) {
        console.error('„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Ç®„É©„Éº:', error);
        return [];
    }
}

async function getPlayerRank(playerId, playerPoints) {
    try {
        const allPlayersQuery = window.firestore.query(
            window.firestore.collection(window.db, 'players'),
            window.firestore.orderBy('totalPoints', 'desc')
        );
        
        const querySnapshot = await window.firestore.getDocs(allPlayersQuery);
        let rank = 1;
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.totalPoints > playerPoints) {
                rank++;
            }
        });
        
        return rank;
    } catch (error) {
        console.error('È†Ü‰ΩçÂèñÂæó„Ç®„É©„Éº:', error);
        return null;
    }
}

async function displayFirebaseRanking() {
    const rankings = await fetchTopRanking(10);
    const myRank = await getPlayerRank(playerId, totalPoints);
    
    const rankingDialog = document.createElement('div');
    rankingDialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.8); z-index: 2000; 
        display: flex; align-items: center; justify-content: center;
    `;
    
    let rankingHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2 style="color: #f57c00; margin-bottom: 20px; text-align: center;">üåç „Ç∞„É≠„Éº„Éê„É´„É©„É≥„Ç≠„É≥„Ç∞</h2>
    `;
    
    if (rankings.length === 0) {
        rankingHTML += '<p style="text-align: center;">„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    } else {
        const medals = ["ü•á", "ü•à", "ü•â"];
        rankings.forEach((ranking, index) => {
            const medal = index < 3 ? medals[index] : `${index + 1}‰Ωç`;
            const isMyRank = ranking.playerId === playerId ? 'background: #e8f5e8; border: 2px solid #4caf50; font-weight: bold;' : 'background: #fff8e1;';
            
            rankingHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                           padding: 10px 15px; margin: 5px 0; border-radius: 5px; ${isMyRank}">
                    <span><span style="font-size: 18px; margin-right: 10px;">${medal}</span></span>
                    <span>ID: ${ranking.playerId}</span>
                    <span>${ranking.totalPoints}P</span>
                </div>
            `;
        });
        
        if (myRank <= 10) {
            rankingHTML += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                    <h4 style="text-align: center; color: #333;">„ÅÇ„Å™„Åü„ÅÆÈ†Ü‰Ωç</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; 
                               padding: 10px 15px; margin: 5px 0; border-radius: 5px; 
                               background: #e8f5e8; border: 2px solid #4caf50; font-weight: bold;">
                        <span><strong>${myRank || 'ÂúèÂ§ñ'}‰Ωç</strong></span>
                        <span><strong>ID: ${playerId}</strong></span>
                        <span><strong>${totalPoints}P</strong></span>
                    </div>
                </div>
            `;
        }
    }
    
    rankingHTML += `
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-top: 20px; padding: 12px 24px; font-size: 16px; 
                           background: #4CAF50; color: white; border: none; border-radius: 8px; 
                           cursor: pointer; display: block; margin-left: auto; margin-right: auto;">
                Èñâ„Åò„Çã
            </button>
        </div>
    `;
    
    rankingDialog.innerHTML = rankingHTML;
    document.body.appendChild(rankingDialog);
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†Èñ¢ÈÄ£„ÅÆÂ§âÊï∞„Å®„Éï„É©„Ç∞
let bonusGameActive = false;
let bonusGameScore = 0;
let bonusTargetMultiple = 0;
let bonusGameTimer = null;
let bonusTimeRemaining = 30;
let bonusPlayerPosition = 50;
let bonusKeys = {};
let bonusCorrectHits = 0;
let bonusTotalHits = 0;
let bonusNumbersDropped = 0;
let bonusMultiplesDropped = 0;
let bonusBullets = [];
let bonusGameInterval = null;
let bonusIsSpinning = false;
let pendingLevelUp = false; // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂæÖÊ©ü„Éï„É©„Ç∞

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆË°®Á§∫
function showBonusGame() {
    if (bonusGameActive) return; // Êó¢„Å´„Éú„Éº„Éä„Çπ„Ç≤„Éº„É†‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    
    bonusGameActive = true;
    const bonusContainer = document.getElementById('bonusGameContainer');
    bonusContainer.classList.add('active');
    
    // „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆÂàùÊúüÂåñ
    resetBonusGame();
    
    // Êòü„ÅÆËÉåÊôØ„ÇíÁîüÊàê
    createBonusStars();
    
    // „É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„ÇíË°®Á§∫
    showBonusRouletteSetup();
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÇíÈö†„Åô
function hideBonusGame() {
    bonusGameActive = false;
    const bonusContainer = document.getElementById('bonusGameContainer');
    bonusContainer.classList.remove('active');
    
    // „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    cleanupBonusGame();
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆ„É™„Çª„ÉÉ„Éà
function resetBonusGame() {
    bonusGameScore = 0;
    bonusTargetMultiple = 0;
    bonusTimeRemaining = 30;
    bonusPlayerPosition = 50;
    bonusCorrectHits = 0;
    bonusTotalHits = 0;
    bonusNumbersDropped = 0;
    bonusMultiplesDropped = 0;
    bonusBullets = [];
    bonusIsSpinning = false;
    
    if (bonusGameTimer) {
        clearInterval(bonusGameTimer);
        bonusGameTimer = null;
    }
    
    if (bonusGameInterval) {
        clearInterval(bonusGameInterval);
        bonusGameInterval = null;
    }
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
function cleanupBonusGame() {
    resetBonusGame();
    
    // ÂÖ®„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„ÄÅ„É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
    document.getElementById('bonusRouletteSetup').classList.remove('active');
    document.getElementById('bonusGameSetup').classList.remove('active');
    document.getElementById('bonusShootingGame').classList.remove('active');
    document.getElementById('bonusGameOver').classList.remove('active');
    
    document.getElementById('bonusRouletteSetup').classList.add('active');
    
    // „É´„Éº„É¨„ÉÉ„Éà„Çí„É™„Çª„ÉÉ„Éà
    const wheel = document.getElementById('bonusRouletteWheel');
    if (wheel) {
        wheel.style.transform = 'rotate(0deg)';
    }
    
    // „Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
    const shootingArea = document.getElementById('bonusShootingArea');
    if (shootingArea) {
        shootingArea.querySelectorAll('.bonus-falling-number, .bonus-bullet').forEach(el => {
            if (el.parentNode) {
                el.remove();
            }
        });
    }
}

// „Éú„Éº„Éä„ÇπÊòü„ÅÆËÉåÊôØ„ÇíÁîüÊàê
function createBonusStars() {
    const starsContainer = document.getElementById('bonusStars');
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'bonus-star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
    }
}

// „Éú„Éº„Éä„Çπ„É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„ÇíË°®Á§∫
function showBonusRouletteSetup() {
    document.getElementById('bonusRouletteSetup').classList.add('active');
    document.getElementById('bonusGameSetup').classList.remove('active');
    document.getElementById('bonusShootingGame').classList.remove('active');
    document.getElementById('bonusGameOver').classList.remove('active');
}

// „Éú„Éº„Éä„Çπ„É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„Åô
function bonusSpinRoulette() {
    if (bonusIsSpinning) return;
    
    bonusIsSpinning = true;
    const wheel = document.getElementById('bonusRouletteWheel');
    const spinBtn = document.getElementById('bonusSpinBtn');
    
    spinBtn.disabled = true;
    spinBtn.textContent = 'ÂõûËª¢‰∏≠...';
    
    const minRotations = 3;
    const randomRotations = Math.random() * 2;
    const totalRotations = minRotations + randomRotations;
    
    const segments = 8;
    const segmentAngle = 360 / segments;
    const finalSegment = Math.floor(Math.random() * segments);
    const finalAngle = finalSegment * segmentAngle + (segmentAngle / 2);
    
    bonusTargetMultiple = finalSegment + 2;
    
    const totalAngle = totalRotations * 360 + finalAngle;
    
    wheel.style.transform = `rotate(${totalAngle}deg)`;
    
    setTimeout(() => {
        bonusIsSpinning = false;
        document.getElementById('bonusRouletteSetup').classList.remove('active');
        document.getElementById('bonusGameSetup').classList.add('active');
        
        document.getElementById('bonusTargetInfo').textContent = `ÁõÆÊ®ô„ÅÆÂÄçÊï∞: ${bonusTargetMultiple}„ÅÆÂÄçÊï∞`;
        
        spinBtn.disabled = false;
        spinBtn.textContent = 'üé≤ „É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„ÅôÔºÅ';
    }, 1500);
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†ÈñãÂßã
function bonusStartGame() {
    document.getElementById('bonusGameSetup').classList.remove('active');
    document.getElementById('bonusShootingGame').classList.add('active');
    
    document.getElementById('bonusGameInstructions').innerHTML = `<strong>${bonusTargetMultiple}„ÅÆÂÄçÊï∞„ÇíÊíÉ„Å¶ÔºÅ</strong>`;
    
    bonusGameScore = 0;
    bonusTimeRemaining = 30;
    bonusPlayerPosition = 50;
    bonusCorrectHits = 0;
    bonusTotalHits = 0;
    bonusNumbersDropped = 0;
    bonusMultiplesDropped = 0;
    bonusBullets = [];
    
    bonusUpdateGameScore();
    bonusUpdateTimer();
    bonusUpdatePlayerPosition();
    bonusStartFallingNumbers();
    bonusSetupShooting();
    
    bonusGameTimer = setInterval(() => {
        bonusTimeRemaining--;
        bonusUpdateTimer();
        if (bonusTimeRemaining <= 0) {
            bonusEndShootingGame();
        }
    }, 1000);
}

// „Éú„Éº„Éä„Çπ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
function bonusUpdatePlayerPosition() {
    const player = document.getElementById('bonusPlayer');
    const shootingArea = document.getElementById('bonusShootingArea');
    const playerWidth = 40;
    const maxLeft = shootingArea.offsetWidth - playerWidth;
    
    const minPosition = 10;
    const maxPosition = 90;
    bonusPlayerPosition = Math.max(minPosition, Math.min(maxPosition, bonusPlayerPosition));
    
    const leftPos = ((bonusPlayerPosition - minPosition) / (maxPosition - minPosition)) * (maxLeft - playerWidth) + playerWidth/2;
    player.style.left = leftPos + 'px';
}

// „Éú„Éº„Éä„Çπ„Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
function bonusUpdateTimer() {
    document.getElementById('bonusGameTimer').textContent = `ÊÆã„ÇäÊôÇÈñì: ${bonusTimeRemaining}Áßí`;
}

// „Éú„Éº„Éä„ÇπËêΩ‰∏ã„Åô„ÇãÊï∞Â≠ó„ÇíÈñãÂßã
function bonusStartFallingNumbers() {
    bonusGameInterval = setInterval(() => {
        if (bonusNumbersDropped < 60 && bonusTimeRemaining > 0) {
            const shouldCreateMultiple = bonusMultiplesDropped < 20 && 
                (Math.random() < 0.4 || (bonusTimeRemaining <= 10 && bonusMultiplesDropped < 15));
            
            bonusCreateFallingNumber(shouldCreateMultiple);
            bonusNumbersDropped++;
        }
    }, 500);
}

// „Éú„Éº„Éä„ÇπËêΩ‰∏ã„Åô„ÇãÊï∞Â≠ó„Çí‰ΩúÊàê
function bonusCreateFallingNumber(forceMultiple = false) {
    if (bonusTimeRemaining <= 0 || bonusNumbersDropped >= 60) return;
    
    const shootingArea = document.getElementById('bonusShootingArea');
    const numberElement = document.createElement('div');
    numberElement.className = 'bonus-falling-number';
    
    let randomNumber;
    let isMultiple;
    
    if (forceMultiple && bonusMultiplesDropped < 20) {
        const multipleIndex = Math.floor(Math.random() * 10) + 1;
        randomNumber = bonusTargetMultiple * multipleIndex;
        if (randomNumber > 100) {
            randomNumber = bonusTargetMultiple * (Math.floor(Math.random() * 5) + 1);
        }
        isMultiple = true;
        bonusMultiplesDropped++;
    } else {
        randomNumber = Math.floor(Math.random() * 100) + 1;
        isMultiple = randomNumber % bonusTargetMultiple === 0;
        if (isMultiple) {
            bonusMultiplesDropped++;
        }
    }
    
    numberElement.textContent = randomNumber;
    numberElement.dataset.number = randomNumber;
    numberElement.dataset.isMultiple = isMultiple;
    
    const numberWidth = 50;
    const margin = 30;
    const minLeft = margin;
    const maxLeft = shootingArea.offsetWidth - numberWidth - margin;
    const leftPosition = Math.random() * (maxLeft - minLeft) + minLeft;
    
    numberElement.style.left = leftPosition + 'px';
    numberElement.style.top = '0px';
    
    shootingArea.appendChild(numberElement);
    bonusAnimateFallingNumber(numberElement);
}

// „Éú„Éº„Éä„ÇπÊï∞Â≠ó„ÅÆËêΩ‰∏ã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
function bonusAnimateFallingNumber(numberElement) {
    const fallInterval = setInterval(() => {
        const currentTop = parseInt(numberElement.style.top);
        const shootingArea = document.getElementById('bonusShootingArea');
        
        if (currentTop > shootingArea.offsetHeight || bonusTimeRemaining <= 0) {
            if (numberElement.parentNode) {
                numberElement.remove();
            }
            clearInterval(fallInterval);
        } else {
            numberElement.style.top = (currentTop + 2.5) + 'px';
        }
    }, 20);
}

// „Éú„Éº„Éä„ÇπÂ∞ÑÊíÉ„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö
function bonusSetupShooting() {
    const shootingArea = document.getElementById('bonusShootingArea');
    
    // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
    shootingArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = shootingArea.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const newPosition = (x / shootingArea.offsetWidth) * 100;
        bonusPlayerPosition = Math.max(10, Math.min(90, newPosition));
        bonusUpdatePlayerPosition();
    });
    
    shootingArea.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const rect = shootingArea.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const newPosition = (x / shootingArea.offsetWidth) * 100;
        bonusPlayerPosition = Math.max(10, Math.min(90, newPosition));
        bonusUpdatePlayerPosition();
    });
    
    shootingArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        bonusFireBullet();
    });
    
    // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
    shootingArea.addEventListener('mousemove', (e) => {
        const rect = shootingArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const newPosition = (x / shootingArea.offsetWidth) * 100;
        bonusPlayerPosition = Math.max(10, Math.min(90, newPosition));
        bonusUpdatePlayerPosition();
    });
    
    shootingArea.addEventListener('click', (e) => {
        if (bonusTimeRemaining > 0) {
            bonusFireBullet();
        }
    });
    
    // „Ç≠„Éº„Éú„Éº„ÉâÁßªÂãï
    const moveInterval = setInterval(() => {
        if (bonusTimeRemaining <= 0 || !bonusGameActive) {
            clearInterval(moveInterval);
            return;
        }
        
        if (bonusKeys['ArrowLeft'] || bonusKeys['a'] || bonusKeys['A']) {
            bonusPlayerPosition = Math.max(10, bonusPlayerPosition - 2);
            bonusUpdatePlayerPosition();
        }
        if (bonusKeys['ArrowRight'] || bonusKeys['d'] || bonusKeys['D']) {
            bonusPlayerPosition = Math.min(90, bonusPlayerPosition + 2);
            bonusUpdatePlayerPosition();
        }
    }, 16);
}

// „Éú„Éº„Éä„ÇπÂºæ„ÇíÁô∫Â∞Ñ
function bonusFireBullet() {
    const shootingArea = document.getElementById('bonusShootingArea');
    const player = document.getElementById('bonusPlayer');
    const bullet = document.createElement('div');
    bullet.className = 'bonus-bullet';
    
    const playerRect = player.getBoundingClientRect();
    const shootingRect = shootingArea.getBoundingClientRect();
    const bulletX = playerRect.left - shootingRect.left + 16;
    
    bullet.style.left = bulletX + 'px';
    bullet.style.bottom = '50px';
    
    shootingArea.appendChild(bullet);
    
    const bulletObj = {
        element: bullet,
        active: true,
        hasHit: false
    };
    bonusBullets.push(bulletObj);
    
    const bulletInterval = setInterval(() => {
        if (!bulletObj.active || bulletObj.hasHit || !bonusGameActive) {
            clearInterval(bulletInterval);
            return;
        }
        
        const currentBottom = parseInt(bullet.style.bottom);
        if (currentBottom > shootingArea.offsetHeight || bonusTimeRemaining <= 0) {
            if (bullet.parentNode) {
                bullet.remove();
            }
            bulletObj.active = false;
            clearInterval(bulletInterval);
        } else {
            bullet.style.bottom = (currentBottom + 5) + 'px';
            
            const hitTarget = bonusCheckCollision(bullet, bulletObj);
            if (hitTarget) {
                bulletObj.hasHit = true;
                bulletObj.active = false;
                if (bullet.parentNode) {
                    bullet.remove();
                }
                clearInterval(bulletInterval);
            }
        }
    }, 20);
}

// „Éú„Éº„Éä„ÇπË°ùÁ™ÅÂà§ÂÆö
function bonusCheckCollision(bullet, bulletObj) {
    if (bulletObj.hasHit || !bulletObj.active) {
        return false;
    }
    
    const bulletRect = bullet.getBoundingClientRect();
    const numbers = document.querySelectorAll('.bonus-falling-number');
    
    for (let numberElement of numbers) {
        const numberRect = numberElement.getBoundingClientRect();
        
        if (bulletRect.left < numberRect.right &&
            bulletRect.right > numberRect.left &&
            bulletRect.top < numberRect.bottom &&
            bulletRect.bottom > numberRect.top) {
            
            const isMultiple = numberElement.dataset.isMultiple === 'true';
            bonusTotalHits++;
            
            if (isMultiple) {
                bonusGameScore += 10;
                bonusCorrectHits++;
            } else {
                bonusGameScore = Math.max(0, bonusGameScore - 5);
            }
            
            bonusUpdateGameScore();
            if (numberElement.parentNode) {
                numberElement.remove();
            }
            
            return true;
        }
    }
    return false;
}

// „Éú„Éº„Éä„Çπ„Çπ„Ç≥„Ç¢Êõ¥Êñ∞
function bonusUpdateGameScore() {
    document.getElementById('bonusGameScore').textContent = `„Çπ„Ç≥„Ç¢: ${bonusGameScore}`;
}

// „Éú„Éº„Éä„Çπ„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≤„Éº„É†ÁµÇ‰∫Ü
function bonusEndShootingGame() {
    if (bonusGameInterval) {
        clearInterval(bonusGameInterval);
        bonusGameInterval = null;
    }
    if (bonusGameTimer) {
        clearInterval(bonusGameTimer);
        bonusGameTimer = null;
    }
    
    bonusBullets.forEach(bulletObj => {
        bulletObj.active = false;
        bulletObj.hasHit = true;
    });
    
    setTimeout(() => {
        bonusShowGameOver();
    }, 1000);
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†ÁµÇ‰∫ÜÁîªÈù¢„ÇíË°®Á§∫
function bonusShowGameOver() {
    document.getElementById('bonusShootingGame').classList.remove('active');
    document.getElementById('bonusGameOver').classList.add('active');
    
    document.getElementById('bonusFinalScore').textContent = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${bonusGameScore}„Éù„Ç§„É≥„Éà`;
    
    let achievements = '';
    const accuracy = bonusTotalHits > 0 ? Math.round((bonusCorrectHits / bonusTotalHits) * 100) : 0;
    
    achievements += `üéØ ${bonusTargetMultiple}„ÅÆÂÄçÊï∞„Çí ${bonusCorrectHits} ÂÄãÊíÉÁ†¥ÔºÅ<br>`;
    achievements += `üìä Ê≠£Ëß£Áéá: ${accuracy}%<br>`;
    achievements += `üìà ËêΩ‰∏ã„Åó„ÅüÊï∞Â≠ó: ${bonusNumbersDropped} ÂÄã<br>`;
    achievements += `üé≤ ËêΩ‰∏ã„Åó„ÅüÂÄçÊï∞: ${bonusMultiplesDropped} ÂÄã<br>`;
    
    if (bonusGameScore >= 150) {
        achievements += '‚ú® 150„Éù„Ç§„É≥„ÉàÈÅîÊàêÔºÅ<br>';
    } else if (bonusGameScore >= 100) {
        achievements += 'üåü 100„Éù„Ç§„É≥„ÉàÈÅîÊàêÔºÅ<br>';
    }
    
    if (accuracy >= 80) {
        achievements += 'üèÜ È´òÁ≤æÂ∫¶„Ç∑„É•„Éº„Çø„ÉºÔºÅ<br>';
    }
    
    if (bonusCorrectHits >= 15) {
        achievements += 'üéØ „Ç®„ÇØ„Çª„É¨„É≥„ÉàÔºÅ15ÂÄã‰ª•‰∏äÊíÉÁ†¥ÔºÅ<br>';
    }
    
    document.getElementById('bonusAchievements').innerHTML = achievements;
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„Åã„Çâ„É°„Ç§„É≥„Ç≤„Éº„É†„Å´Êàª„Çã
async function bonusReturnToMainGame() {
    // „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅßÁç≤Âæó„Åó„Åü„Éù„Ç§„É≥„Éà„Çí„É°„Ç§„É≥„Ç≤„Éº„É†„Å´ËøΩÂä†
    if (bonusGameScore > 0) {
        await addPoints(bonusGameScore, true);
    }
    
    // „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÇíÈö†„Åô
    hideBonusGame();
    
    // ÂæÖÊ©ü‰∏≠„ÅÆ„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ„ÇíÂÆüË°å
    if (pendingLevelUp) {
        pendingLevelUp = false;
        
        // „Åæ„Å®„ÇÅ„É¢„Éº„Éâ„Åß„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
        if (state.mode === 'summary') {
            // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            $("monster").classList.add("level-up");
            setTimeout(() => $("monster").classList.remove("level-up"), 3000);
            
            setTimeout(() => {
                state.level++;
                updateLevelIndicator();
                updateProgressBar();
                newProblem();
            }, 1000);
        }
    }
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÅÆ„Éõ„Éº„É†„Å´Êàª„Çã
function bonusGoHome() {
    hideBonusGame();
    
    // „É°„Ç§„É≥„Ç≤„Éº„É†„Å´Êàª„Çã
    if (pendingLevelUp) {
        bonusReturnToMainGame();
    }
}

// „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†Áî®„ÅÆ„Ç≠„Éº„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
document.addEventListener('keydown', (e) => {
    if (bonusGameActive) {
        bonusKeys[e.key] = true;
        
        if ((e.key === ' ' || e.key === 'Enter') && document.getElementById('bonusShootingGame').classList.contains('active')) {
            e.preventDefault();
            if (bonusTimeRemaining > 0) {
                bonusFireBullet();
            }
        }
    }
});

document.addEventListener('keyup', (e) => {
    if (bonusGameActive) {
        bonusKeys[e.key] = false;
    }
});

const $=id=>document.getElementById(id)||{style:{},textContent:'',innerHTML:'',value:'',classList:{add:()=>{},remove:()=>{}},appendChild:()=>{},remove:()=>{},focus:()=>{},disabled:false};
let state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,selectCorrectCount:0,clearedLevels:new Set(),formulaCorrectCount:0,answerSubmitted:false};
const monsters=["‚úñÔ∏è","üìè","‚ú®","üî¢","üéØ"];
const lvNames=["‰ΩïÂÄç„Åã","„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï","Â∞èÊï∞ÂÄç„Åó„ÅüÊï∞","„ÇÇ„Å®„ÅÆ‰ΩïÂÄç„Åã","„ÅÑ„Çç„ÅÑ„Çç„Å™ÂïèÈ°å"];
let totalPoints=0,hiddenStageAvailable=false,playerId='';

// Â∞èÊï∞„ÅÆÊéõ„ÅëÁÆó„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Éá„Éº„ÇøÔºàÂ∞èÊï∞Á¨¨‰∫å‰Ωç„ÅßÂâ≤„ÇäÂàá„Çå„ÇãÔºâ
const multiplicationCombinations = [
    [0.1, 0.2, 0.02], [0.1, 0.3, 0.03], [0.1, 0.4, 0.04], [0.1, 0.5, 0.05],
    [0.1, 0.6, 0.06], [0.1, 0.7, 0.07], [0.1, 0.8, 0.08], [0.1, 0.9, 0.09],
    [0.2, 0.2, 0.04], [0.2, 0.3, 0.06], [0.2, 0.4, 0.08], [0.2, 0.5, 0.10],
    [0.2, 0.6, 0.12], [0.2, 0.7, 0.14], [0.2, 0.8, 0.16], [0.2, 0.9, 0.18],
    [0.3, 0.3, 0.09], [0.3, 0.4, 0.12], [0.3, 0.5, 0.15], [0.3, 0.6, 0.18],
    [0.3, 0.7, 0.21], [0.3, 0.8, 0.24], [0.3, 0.9, 0.27], [0.4, 0.4, 0.16],
    [0.4, 0.5, 0.20], [0.4, 0.6, 0.24], [0.4, 0.7, 0.28], [0.4, 0.8, 0.32],
    [0.4, 0.9, 0.36], [0.5, 0.5, 0.25], [0.5, 0.6, 0.30], [0.5, 0.7, 0.35],
    [0.5, 0.8, 0.40], [0.5, 0.9, 0.45], [0.6, 0.6, 0.36], [0.6, 0.7, 0.42],
    [0.6, 0.8, 0.48], [0.6, 0.9, 0.54], [0.7, 0.7, 0.49], [0.7, 0.8, 0.56],
    [0.7, 0.9, 0.63], [0.8, 0.8, 0.64], [0.8, 0.9, 0.72], [0.9, 0.9, 0.81],
    [1.1, 1.1, 1.21], [1.1, 1.2, 1.32], [1.1, 1.3, 1.43], [1.1, 1.4, 1.54],
    [1.1, 1.5, 1.65], [1.1, 1.6, 1.76], [1.1, 1.7, 1.87], [1.1, 1.8, 1.98],
    [1.2, 1.2, 1.44], [1.2, 1.3, 1.56], [1.2, 1.4, 1.68], [1.2, 1.5, 1.80],
    [1.2, 1.6, 1.92], [1.2, 1.7, 2.04], [1.2, 1.8, 2.16], [1.3, 1.3, 1.69],
    [1.3, 1.4, 1.82], [1.3, 1.5, 1.95], [1.3, 1.6, 2.08], [1.3, 1.7, 2.21],
    [1.4, 1.4, 1.96], [1.4, 1.5, 2.10], [1.4, 1.6, 2.24], [1.5, 1.5, 2.25],
    [1.5, 1.6, 2.40], [1.6, 1.6, 2.56]
];

function generatePlayerId(){
    const now=new Date();
    const year=now.getFullYear();
    const month=(now.getMonth()+1).toString().padStart(2,'0');
    const day=now.getDate().toString().padStart(2,'0');
    const hour=now.getHours().toString().padStart(2,'0');
    const minute=now.getMinutes().toString().padStart(2,'0');
    const second=now.getSeconds().toString().padStart(2,'0');
    return`${year}${month}${day}${hour}${minute}${second}`;
}

function initializePlayerId(){
    try{
        playerId=localStorage.getItem('playerId');
        if(!playerId){
            playerId=generatePlayerId();
            localStorage.setItem('playerId',playerId);
        }
    }catch(e){
        playerId=generatePlayerId();
    }
}

function loadClearedLevels(){
    try{
        const saved=localStorage.getItem('clearedLevels');
        if(saved){
            state.clearedLevels=new Set(JSON.parse(saved));
        }
    }catch(e){}
}

function saveClearedLevels(){
    try{
        localStorage.setItem('clearedLevels',JSON.stringify([...state.clearedLevels]));
    }catch(e){}
}

function updateLevelSelectDisplay(){
    for(let i=1;i<=5;i++){
        const levelBtn=document.querySelector(`.level-btn:nth-child(${i})`);
        if(levelBtn){
            if(state.clearedLevels.has(i)){
                levelBtn.classList.add('cleared');
            }else{
                levelBtn.classList.remove('cleared');
            }
        }
    }
}

function saveToGlobalRanking(points){
    try{
        let globalRanking=JSON.parse(localStorage.getItem('globalRanking')||'[]');
        const existingIndex=globalRanking.findIndex(entry=>entry.id===playerId);
        
        if(existingIndex>=0){
            if(globalRanking[existingIndex].points<points){
                globalRanking[existingIndex].points=points;
                globalRanking[existingIndex].lastUpdate=new Date().toISOString();
            }
        }else{
            globalRanking.push({
                id:playerId,
                points:points,
                lastUpdate:new Date().toISOString()
            });
        }
        
        globalRanking.sort((a,b)=>b.points-a.points);
        globalRanking=globalRanking.slice(0,1000);
        localStorage.setItem('globalRanking',JSON.stringify(globalRanking));
        return globalRanking;
    }catch(e){
        return[];
    }
}

function displayGlobalRanking(containerId,myRankId){
    const globalRanking=saveToGlobalRanking(totalPoints);
    const myRank=globalRanking.findIndex(entry=>entry.id===playerId)+1;
    
    $(containerId.replace('#','')).style.display="block";
    const rankingList=$(containerId.replace('#','')+'List');
    rankingList.innerHTML="";
    
    const medals=["ü•á","ü•à","ü•â"];
    for(let i=0;i<Math.min(10,globalRanking.length);i++){
        const rankDiv=document.createElement("div");
        rankDiv.className="global-ranking-item";
        if(globalRanking[i].id===playerId)rankDiv.classList.add("my-rank");
        
        const medal = i < 3 ? medals[i] : `${i+1}‰Ωç`;
        rankDiv.innerHTML=`
            <span><span class="rank-medal">${medal}</span></span>
            <span>ID: ${globalRanking[i].id}</span>
            <span>${globalRanking[i].points}P</span>
        `;
        rankingList.appendChild(rankDiv);
    }
    
    if(myRankId && myRank <= 10){
        const myRankDiv=$(myRankId.replace('#',''));
        myRankDiv.innerHTML=`
            <div class="global-ranking-item my-rank">
                <span><strong>${myRank}‰Ωç</strong></span>
                <span><strong>ID: ${playerId}</strong></span>
                <span><strong>${totalPoints}P</strong></span>
            </div>
        `;
    }
}

function enableHiddenStage(){hiddenStageAvailable=true;$("hiddenStageBtn").style.display="inline-block";$("hiddenModeInfo").style.display="block"}
function disableHiddenStage(){hiddenStageAvailable=false;$("hiddenStageBtn").style.display="none";$("hiddenModeInfo").style.display="none"}

try{totalPoints=parseInt(localStorage.getItem('totalPoints')||'0')}catch(e){}
const titles={decimalMaster:{name:"Â∞èÊï∞„ÅÆÂÄç„Éû„Çπ„Çø„Éº",description:"Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇíÂà∂Ë¶á„Åó„ÅüÁúü„ÅÆÂ∞èÊï∞„ÅÆÂÄç„ÅÆÈÅî‰∫∫",unlocked:false}};

window.addEventListener('load',()=>{
    initializePlayerId();
    loadClearedLevels();
    $("playerIdDisplay").style.display="block";
    $("playerId").textContent=playerId;
    if(totalPoints>0){
        $("pointsDisplay").style.display="block";
        $("totalPoints").textContent=totalPoints;
    }
});

const R=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
function formatTime(s){const m=Math.floor(s/60);return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`}

function calculateClearPoints(clearTime){
    const basePoints = 2000;
    if(clearTime<=300)return basePoints * 5;
    else if(clearTime<=600)return 1500 * 5;
    else if(clearTime<=900)return 1200 * 5;
    else if(clearTime<=1200)return 1000 * 5;
    else if(clearTime<=1800)return 800 * 5;
    else return 500 * 5;
}

function calculateLevelPoints(level,mode){
    const basePoints = level*50;
    if(mode==='practice')return Math.floor(basePoints*0.3);
    else if(mode==='select')return Math.floor(basePoints*0.5);
    else if(mode==='formula')return Math.floor(basePoints*0.4);
    else return basePoints;
}

function calculateCorrectPoints(level,mode){
    const basePoints = Math.min(level*10,100);
    if(mode==='practice')return Math.floor(basePoints*0.3);
    else if(mode==='select')return Math.floor(basePoints*0.1);
    else if(mode==='formula')return Math.floor(basePoints*0.2);
    else return basePoints;
}

async function addPoints(points,showAnimation=true){
    totalPoints+=points;
    state.sessionPoints+=points;
    try{localStorage.setItem('totalPoints',totalPoints.toString())}catch(e){}
    $("totalPoints").textContent=totalPoints;
    $("sessionPointsValue").textContent=state.sessionPoints;
    $("pointsDisplay").style.display="block";
    $("sessionPoints").style.display="block";
    
    await savePlayerScore(playerId, totalPoints);
    
    if(showAnimation)showPointsAnimation(points);
}

function showPointsAnimation(points){
    const pointsDiv=document.createElement('div');
    pointsDiv.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:20px;border-radius:15px;font-size:24px;font-weight:bold;z-index:3000;animation:pointsEarn 2s;border:3px solid #ff6b6b;">+${points}P Áç≤ÂæóÔºÅ</div>`;
    document.body.appendChild(pointsDiv);
    setTimeout(()=>pointsDiv.remove(),2000);
}

function startTimer(){
    if(state.mode==='summary'||state.mode==='hidden'){
        state.startTime=Date.now();
        $("timerDisplay").style.display="block";
        state.timerInterval=setInterval(updateTimer,1000);
    }
}

function updateTimer(){
    if(state.startTime){
        const elapsed=Math.floor((Date.now()-state.startTime)/1000);
        $("timer").textContent=formatTime(elapsed);
    }
}

function stopTimer(){
    if(state.timerInterval){
        clearInterval(state.timerInterval);
        state.timerInterval=null;
    }
}

function getElapsedTime(){
    return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0;
}

// Â∞èÊï∞Á¨¨‰∫å‰Ωç„ÅßÂõõÊç®‰∫îÂÖ•„Åô„ÇãÈñ¢Êï∞
function roundToTwoDecimals(num) {
    return Math.round(num * 100) / 100;
}

// Êéõ„ÅëÁÆó„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Åã„ÇâÂâ≤„ÇäÂàá„Çå„ÇãÂïèÈ°å„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
function generateFromCombinations(unit = "ÂÄç") {
    const combination = multiplicationCombinations[R(0, multiplicationCombinations.length - 1)];
    const [factor1, factor2, product] = combination;
    
    const pattern = R(1, 2);
    
    if(pattern === 1) {
        // product √∑ factor1 = factor2
        return {
            dividend: product,
            divisor: factor1,
            answer: factor2,
            unit: unit
        };
    } else {
        // product √∑ factor2 = factor1
        return {
            dividend: product,
            divisor: factor2,
            answer: factor1,
            unit: unit
        };
    }
}

function generateHiddenProblem(){
    const type=R(1,5);
    switch(type){
        case 1:{
            // Ë§áÈõë„Å™‰ΩïÂÄçÂïèÈ°å
            const result = generateFromCombinations();
            return{
                q:`A„ÅÆÈáç„Åï„ÅØ${result.dividend}kg„Åß„Åô„ÄÇB„ÅÆÈáç„Åï„ÅØ${result.divisor}kg„Åß„Åô„ÄÇA„ÅÆÈáç„Åï„ÅØB„ÅÆÈáç„Åï„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                answer:result.answer,
                unit:"ÂÄç"
            };
        }
        case 2:{
            // Ë§áÈõë„Å™„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„ÅïÂïèÈ°å
            const result = generateFromCombinations("ÂÜÜ");
            return{
                q:`ÁèæÂú®„ÅÆÂÄ§ÊÆµ„ÅØ${result.dividend}ÂÜÜ„Åß„Åô„ÄÇ„Åì„Çå„ÅØÂÖÉ„ÅÆÂÄ§ÊÆµ„ÅÆ${result.divisor}ÂÄç„Åß„Åô„ÄÇÂÖÉ„ÅÆÂÄ§ÊÆµ„ÅØ‰ΩïÂÜÜ„Åß„Åó„Åü„ÅãÔºü`,
                answer:result.answer,
                unit:"ÂÜÜ"
            };
        }
        case 3:{
            // Ë§áÈõë„Å™„ÇÇ„Å®„ÅÆ‰ΩïÂÄçÂïèÈ°å
            const result = generateFromCombinations();
            return{
                q:`ÂÖÉ„ÅÆÂÄ§ÊÆµ„ÅØ${result.divisor}ÂÜÜ„Åß„Åó„Åü„ÄÇÁèæÂú®„ÅÆÂÄ§ÊÆµ„ÅØ${result.dividend}ÂÜÜ„Åß„Åô„ÄÇÁèæÂú®„ÅÆÂÄ§ÊÆµ„ÅØÂÖÉ„ÅÆÂÄ§ÊÆµ„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                answer:result.answer,
                unit:"ÂÄç"
            };
        }
        case 4:{
            // 3ÊÆµÈöé„ÅÆÂïèÈ°å
            const step1Result = generateFromCombinations();
            const step2Result = generateFromCombinations();
            const finalAnswer = roundToTwoDecimals(step1Result.answer / step2Result.divisor);
            
            return{
                q:`A„ÅØ${step1Result.dividend}m„ÄÅB„ÅØ${step1Result.divisor}m„ÄÅC„ÅØ${step2Result.divisor}m„Åß„Åô„ÄÇA„ÅØB„ÅÆ‰ΩïÂÄç„Åß„ÄÅ„Åï„Çâ„Å´„Åù„ÅÆÁµêÊûú„ÇíC„ÅßÂâ≤„Çã„Å®‰ΩïÂÄç„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,
                answer:finalAnswer,
                unit:"ÂÄç"
            };
        }
        case 5:{
            // ÊôÇÈñì„Å®Ë∑ùÈõ¢„ÅÆË§áÂêàÂïèÈ°å
            const result1 = generateFromCombinations();
            const result2 = generateFromCombinations();
            const time = result1.divisor;
            const distance1 = result1.dividend;
            const distance2 = result2.dividend;
            
            const speed1 = roundToTwoDecimals(distance1 / time);
            const speed2 = roundToTwoDecimals(distance2 / time);
            const speedRatio = roundToTwoDecimals(speed1 / speed2);
            
            return{
                q:`${time}ÊôÇÈñì„Åß„ÄÅËªäA„ÅØ${distance1}km„ÄÅËªäB„ÅØ${distance2}kmÈÄ≤„Åø„Åæ„Åó„Åü„ÄÇËªäA„ÅÆÈÄüÂ∫¶„ÅØËªäB„ÅÆÈÄüÂ∫¶„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                answer:speedRatio,
                unit:"ÂÄç"
            };
        }
    }
}

function generateProblem(lv){
    if(state.mode==='hidden')return generateHiddenProblem();
    
    switch(lv){
        case 1:{
            // ‰ΩïÂÄç„Åã
            const type=R(1,2);
            if(type===1){
                // „É™„Éú„É≥„ÅÆÂïèÈ°å
                const askFor=R(1,2)===1?"Ëµ§„ÅÑ":"Èùí„ÅÑ";
                const baseFor=askFor==="Ëµ§„ÅÑ"?"Èùí„ÅÑ":"Ëµ§„ÅÑ";
                
                if(askFor==="Ëµ§„ÅÑ"){
                    const result = generateFromCombinations();
                    return{
                        q:`${result.dividend}ÔΩç„ÅÆËµ§„ÅÑ„É™„Éú„É≥„Å®„ÄÅ${result.divisor}ÔΩç„ÅÆÈùí„ÅÑ„É™„Éú„É≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ${askFor}„É™„Éú„É≥„ÅØ${baseFor}„É™„Éú„É≥„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                        answer:result.answer,
                        formula:`${result.dividend}√∑${result.divisor}`,
                        unit:"ÂÄç"
                    };
                } else {
                    const result = generateFromCombinations();
                    return{
                        q:`${result.divisor}ÔΩç„ÅÆËµ§„ÅÑ„É™„Éú„É≥„Å®„ÄÅ${result.dividend}ÔΩç„ÅÆÈùí„ÅÑ„É™„Éú„É≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ${askFor}„É™„Éú„É≥„ÅØ${baseFor}„É™„Éú„É≥„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                        answer:result.answer,
                        formula:`${result.dividend}√∑${result.divisor}`,
                        unit:"ÂÄç"
                    };
                }
            }else{
                // Ë∑ùÈõ¢„ÅÆÂïèÈ°å
                const result = generateFromCombinations();
                return{
                    q:`„ÅØ„Çã„Åã„Åï„Çì„ÅÆÂÆ∂„Åã„ÇâÈßÖ„Åæ„Åß„ÅØ${result.divisor}ÔΩãÔΩç„Åß„Åô„ÄÇ„Å≤„Çç„Åó„Åï„Çì„ÅÆÂÆ∂„Åã„ÇâÈßÖ„Åæ„Åß„ÅØ${result.dividend}ÔΩãÔΩç„Åß„Åô„ÄÇ„ÅØ„Çã„Åã„Åï„Çì„ÅÆÈÅì„ÅÆ„Çä„Çí„ÇÇ„Å®„Å´„Åô„Çã„Å®„ÄÅ„Å≤„Çç„Åó„Åï„Çì„ÅÆÈÅì„ÅÆ„Çä„ÅØ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                    answer:result.answer,
                    formula:`${result.dividend}√∑${result.divisor}`,
                    unit:"ÂÄç"
                };
            }
        }
        case 2:{
            // „ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï
            const type=R(1,2);
            if(type===1){
                // Áä¨„ÅÆ‰ΩìÈáçÂïèÈ°å
                const result = generateFromCombinations("ÔΩá");
                const currentWeight = Math.round(result.dividend * 100); // „Ç∞„É©„É†Âçò‰Ωç„Å´Ë™øÊï¥
                return{
                    q:`Áä¨„ÅÆ‰ΩìÈáç„ÅØ${currentWeight}ÔΩá„Åß„Åô„ÄÇÁîü„Åæ„Çå„Åü„Å®„Åç„ÅÆ${result.divisor}ÂÄç„Åß„Åô„ÄÇÁîü„Åæ„Çå„ÅüÊôÇ„ÅÆ‰ΩìÈáç„ÅØ‰ΩïÔΩá„Åß„Åó„Åü„ÅãÔºü`,
                    answer:roundToTwoDecimals(currentWeight / result.divisor),
                    formula:`${currentWeight}√∑${result.divisor}`,
                    unit:"ÔΩá"
                };
            }else{
                // „Å∏„Å°„Åæ„ÅÆÂïèÈ°å
                const result = generateFromCombinations("ÔΩÉÔΩç");
                const currentLength = Math.round(result.dividend * 100); // cmÂçò‰Ωç„Å´Ë™øÊï¥
                return{
                    q:`„Å∏„Å°„Åæ„ÅÆ„Åè„Åç„ÅÆÈï∑„Åï„ÅØ${currentLength}ÔΩÉÔΩç„Åß„Åô„ÄÇÂçäÂπ¥Ââç„ÅÆ${result.divisor}ÂÄç„Åß„Åô„ÄÇÂçäÂπ¥Ââç„ÅÆ„Åè„Åç„ÅÆÈï∑„Åï„ÅØ‰ΩïÔΩÉÔΩç„Åß„Åó„Åü„ÅãÔºü`,
                    answer:roundToTwoDecimals(currentLength / result.divisor),
                    formula:`${currentLength}√∑${result.divisor}`,
                    unit:"ÔΩÉÔΩç"
                };
            }
        }
        case 3:{
            // Â∞èÊï∞ÂÄç„Åó„ÅüÊï∞„Çí„ÇÇ„Å®„ÇÅ„ÇãÔºàÊñ∞„Åó„ÅÑ„É¨„Éô„É´3Ôºâ
            const type=R(1,2);
            if(type===1){
                // „ÉÜ„Éº„Éó„ÅÆÂïèÈ°å
                const baseLength = roundToTwoDecimals(R(5, 15) / 10); // 0.5„Åã„Çâ1.5„ÅÆÁØÑÂõ≤
                const multiplier = roundToTwoDecimals(R(11, 25) / 10); // 1.1„Åã„Çâ2.5„ÅÆÁØÑÂõ≤
                const resultLength = roundToTwoDecimals(baseLength * multiplier);
                
                return{
                    q:`Ëµ§„ÅÑ„ÉÜ„Éº„Éó„ÅØ${baseLength}ÔΩç„Åß„Åô„ÄÇÈùí„ÅÑ„ÉÜ„Éº„Éó„ÅØËµ§„ÅÑ„ÉÜ„Éº„Éó„ÅÆ${multiplier}ÂÄç„Åß„Åô„ÄÇÈùí„ÅÑ„ÉÜ„Éº„Éó„ÅÆÈï∑„Åï„ÅØ‰ΩïÔΩç„Åß„Åô„ÅãÔºü`,
                    answer:resultLength,
                    formula:`${baseLength}√ó${multiplier}`,
                    unit:"ÔΩç"
                };
            }else{
                // Èáç„Åï„ÅÆÂïèÈ°å
                const baseWeight = roundToTwoDecimals(R(15, 35) / 10); // 1.5„Åã„Çâ3.5„ÅÆÁØÑÂõ≤
                const multiplier = roundToTwoDecimals(R(11, 25) / 10); // 1.1„Åã„Çâ2.5„ÅÆÁØÑÂõ≤
                const resultWeight = roundToTwoDecimals(baseWeight * multiplier);
                
                return{
                    q:`ËÇâ„Çí${baseWeight}ÔΩãÔΩáË≤∑„ÅÑ„Åæ„Åó„Åü„ÄÇÈáéËèú„ÅØËÇâ„ÅÆ${multiplier}ÂÄçË≤∑„ÅÑ„Åæ„Åó„Åü„ÄÇË≤∑„Å£„ÅüÈáéËèú„ÅÆÈáç„Åï„ÅØ‰ΩïÔΩãÔΩá„Åß„Åô„ÅãÔºü`,
                    answer:resultWeight,
                    formula:`${baseWeight}√ó${multiplier}`,
                    unit:"ÔΩãÔΩá"
                };
            }
        }
        case 4:{
            // „ÇÇ„Å®„ÅÆ‰ΩïÂÄç„ÅãÔºàÊóß„É¨„Éô„É´3Ôºâ
            const type=R(1,2);
            if(type===1){
                // „Åä„Å´„Åé„Çä„ÅÆÂïèÈ°å
                const result = generateFromCombinations();
                const originalPrice = 160;
                const currentPrice = Math.round(result.answer * originalPrice);
                return{
                    q:`„Åä„Å´„Åé„Çä„Åå${originalPrice}ÂÜÜ„Åã„ÇâÂÄ§Âºï„Åç„Åï„Çå„Å¶„ÄÅ${currentPrice}ÂÜÜ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇÂÄ§Âºï„ÅçÂæå„ÅÆÂÄ§ÊÆµ„ÅØ„ÇÇ„Å®„ÅÆÂÄ§ÊÆµ„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                    answer:roundToTwoDecimals(currentPrice / originalPrice),
                    formula:`${currentPrice}√∑${originalPrice}`,
                    unit:"ÂÄç"
                };
            }else{
                // „ÅäÂºÅÂΩì„ÅÆÂïèÈ°å
                const result = generateFromCombinations();
                const originalPrice = 750;
                const currentPrice = Math.round(result.answer * originalPrice);
                return{
                    q:`„ÅäÂºÅÂΩì„Åå${originalPrice}ÂÜÜ„Åã„ÇâÂÄ§Âºï„Åç„Åï„Çå„Å¶„ÄÅ${currentPrice}ÂÜÜ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇÂÄ§Âºï„ÅçÂæå„ÅÆÂÄ§ÊÆµ„ÅØ„ÇÇ„Å®„ÅÆÂÄ§ÊÆµ„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,
                    answer:roundToTwoDecimals(currentPrice / originalPrice),
                    formula:`${currentPrice}√∑${originalPrice}`,
                    unit:"ÂÄç"
                };
            }
        }
        case 5:{
            // „ÅÑ„Çç„ÅÑ„Çç„Å™ÂïèÈ°åÔºà„É¨„Éô„É´1-4„ÅÆ„É©„É≥„ÉÄ„É†Ôºâ
            const randomLevel=R(1,4);
            return generateProblem(randomLevel);
        }
    }
}

// Âºè„Å†„Åë„É¢„Éº„ÉâÁî®„ÅÆÈñ¢Êï∞
function showFormulaLevelSelect(){
    $("start").style.display="none";
    $("formulaLevelSelect").style.display="block";
}

function selectFormulaLevel(level){
    state.level = level;
    state.score = 0;
    state.lvCount = 0;
    state.totalQ = 0;
    state.qNum = 0;
    state.formulaCorrectCount = 0;
    state.sessionPoints = 0;
    state.answerSubmitted = false; // ÂõûÁ≠îÈÄÅ‰ø°„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    
    $("start").style.display = "none";
    $("formulaLevelSelect").style.display = "none";
    $("game").style.display = "block";
    
    state.mode = 'formula';
    $("formulaLevelSelectBtn").style.display = "inline-block";
    $("formulaQ").style.display = "inline-block";
    $("totalQ").style.display = "none";
    $("hiddenQ").style.display = "none";
    $("selectQ").style.display = "none";
    $("modeDisplay").innerHTML = `<div class="mode-info formula"><strong>üìù Âºè„Å†„Åë„É¢„Éº„Éâ</strong> - „É¨„Éô„É´${state.level}</div>`;
    $("progressBar").className = "progress-bar formula";
    
    // Âºè„Å†„Åë„É¢„Éº„ÉâÁî®„ÅÆUIË°®Á§∫
    $("answerTitle").textContent = "Âºè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
    $("normalInput").style.display = "none";
    $("formulaInput").style.display = "flex";
    $("formulaHint").style.display = "block";
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function backToFormulaLevelSelect(){
    $("game").style.display="none";
    $("levelClear").style.display="none";
    $("formulaLevelSelect").style.display="block";
}

function selectLevel(level){
    state.level = level;
    state.score = 0;
    state.lvCount = 0;
    state.totalQ = 0;
    state.qNum = 0;
    state.selectQCount = 0;
    state.selectCorrectCount = 0;
    state.sessionPoints = 0;
    state.answerSubmitted = false; // ÂõûÁ≠îÈÄÅ‰ø°„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    
    $("start").style.display = "none";
    $("levelSelect").style.display = "none";
    $("game").style.display = "block";
    
    state.mode = 'select';
    $("levelSelectBtn").style.display = "inline-block";
    $("selectQ").style.display = "inline-block";
    $("totalQ").style.display = "none";
    $("hiddenQ").style.display = "none";
    $("formulaQ").style.display = "none";
    $("modeDisplay").innerHTML = `<div class="mode-info select"><strong>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</strong> - „É¨„Éô„É´${state.level}</div>`;
    $("progressBar").className = "progress-bar select";
    
    // ÈÄöÂ∏∏„É¢„Éº„ÉâÁî®„ÅÆUIË°®Á§∫
    $("answerTitle").textContent = "Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
    $("normalInput").style.display = "flex";
    $("formulaInput").style.display = "none";
    $("formulaHint").style.display = "none";
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function selectMode(mode){
    state.mode=mode;
    state.score=0;
    state.level=1;
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.selectQCount=0;
    state.hiddenQ=0;
    state.selectCorrectCount=0;
    state.formulaCorrectCount=0;
    state.sessionPoints=0;
    state.answerSubmitted=false; // ÂõûÁ≠îÈÄÅ‰ø°„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("formulaLevelSelect").style.display="none";
    $("game").style.display="block";
    
    if(mode==='select'){
        $("game").style.display="none";
        showLevelSelect();
        return;
    }else if(mode==='formula'){
        $("game").style.display="none";
        showFormulaLevelSelect();
        return;
    }else if(mode==='practice'){
        $("levelSelectBtn").style.display="none";
        $("formulaLevelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("formulaQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>üìö Á∑¥Áøí„É¢„Éº„Éâ</strong></div>';
        $("progressBar").className="progress-bar practice";
        
        // ÈÄöÂ∏∏„É¢„Éº„ÉâÁî®„ÅÆUIË°®Á§∫
        $("answerTitle").textContent = "Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        $("normalInput").style.display = "flex";
        $("formulaInput").style.display = "none";
        $("formulaHint").style.display = "none";
    }else if(mode==='summary'){
        $("levelSelectBtn").style.display="none";
        $("formulaLevelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("formulaQ").style.display="none";
        $("totalQ").style.display="inline-block";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</strong></div>';
        $("progressBar").className="progress-bar summary";
        
        // ÈÄöÂ∏∏„É¢„Éº„ÉâÁî®„ÅÆUIË°®Á§∫
        $("answerTitle").textContent = "Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        $("normalInput").style.display = "flex";
        $("formulaInput").style.display = "none";
        $("formulaHint").style.display = "none";
        
        startTimer();
    }else if(mode==='hidden'){
        $("levelSelectBtn").style.display="none";
        $("formulaLevelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("formulaQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline-block";
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</strong></div>';
        $("progressBar").className="progress-bar hidden";
        
               // ÈÄöÂ∏∏„É¢„Éº„ÉâÁî®„ÅÆUIË°®Á§∫
        $("answerTitle").textContent = "Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        $("normalInput").style.display = "flex";
        $("formulaInput").style.display = "none";
        $("formulaHint").style.display = "none";
        
        startTimer();
    }
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function showLevelSelect(){
    $("start").style.display="none";
    $("levelSelect").style.display="block";
    updateLevelSelectDisplay();
}

function backToStart(){
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("levelClear").style.display="none";
    $("hiddenClear").style.display="none";
    $("levelSelect").style.display="none";
    $("formulaLevelSelect").style.display="none";
    $("start").style.display="block";
    stopTimer();
    
    if(state.sessionPoints>0){
        $("sessionPoints").style.display="block";
    }
}

function backToLevelSelect(){
    $("game").style.display="none";
    $("levelClear").style.display="none";
    showLevelSelect();
}

function updateLevelIndicator(){
    const indicator=$("levelIndicator");
    indicator.innerHTML="";
    
    const maxLevels=state.mode==='hidden'?10:5;
    
    if(state.mode==='practice'){
        for(let i=1;i<=maxLevels;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(state.completed.has(i))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='summary'){
        for(let i=1;i<=maxLevels;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<state.level||(i===state.level&&state.totalQ%5===0&&state.totalQ>0))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='hidden'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.hiddenQ)dot.classList.add("completed");
            if(i===state.hiddenQ+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='select'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.selectCorrectCount)dot.classList.add("completed");
            if(i===state.selectCorrectCount+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='formula'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.formulaCorrectCount)dot.classList.add("completed");
            if(i===state.formulaCorrectCount+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }
}

function updateProgressBar(){
    const progressBar=$("progressBar");
    let progress=0;
    
    if(state.mode==='practice'){
        progress=(state.lvCount/5)*100;
        $("levelProgress").textContent=`„Åì„ÅÆ„É¨„Éô„É´: ${state.lvCount}/5ÂïèÊ≠£Ëß£`;
    }else if(state.mode==='summary'){
        progress=(state.totalQ/25)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='hidden'){
        progress=(state.hiddenQ/10)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='select'){
        progress=(state.selectCorrectCount/10)*100;
        $("levelProgress").textContent=`ÈÄ£Á∂öÊ≠£Ëß£: ${state.selectCorrectCount}/10Âïè`;
    }else if(state.mode==='formula'){
        progress=(state.formulaCorrectCount/10)*100;
        $("levelProgress").textContent=`ÈÄ£Á∂öÊ≠£Ëß£: ${state.formulaCorrectCount}/10Âïè`;
    }
    
    progressBar.style.width=progress+"%";
}

function newProblem(){
    state.prob=generateProblem(state.level);
    state.unit=state.prob.unit||"";
    state.answerSubmitted=false; // Êñ∞„Åó„ÅÑÂïèÈ°å„ÅßÂõûÁ≠îÈÄÅ‰ø°„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    
    $("q").innerHTML=state.prob.q;
    $("monster").textContent=monsters[Math.min(state.level-1, 4)];
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[Math.min(state.level-1, 4)];
    
    // Âçò‰ΩçË°®Á§∫„ÅÆÊõ¥Êñ∞
    if(state.unit && state.mode !== 'formula'){
        $("nUnit").textContent=state.unit;
        $("nUnit").style.display="inline";
    }else{
        $("nUnit").style.display="none";
    }
    
    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÇØ„É™„Ç¢
    $("norm").value="";
    $("num1").value="";
    $("num2").value="";
    $("operator").value="";
    
    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
    const submitBtns = document.querySelectorAll('.submit-btn');
    submitBtns.forEach(btn => btn.disabled = false);
    
    $("wrong").style.display="none";
    
    // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÈÅ©Âàá„Å™ÂÖ•ÂäõÊ¨Ñ„Å´Ë®≠ÂÆö
    setTimeout(() => {
        if(state.mode === 'formula'){
            $("num1").focus();
        }else{
            $("norm").focus();
        }
    }, 100);
}

function submitAnswer(){
    // ÈÄ£ÊâìÈò≤Ê≠¢„ÉÅ„Çß„ÉÉ„ÇØ
    if(state.answerSubmitted){
        return;
    }
    
    state.answerSubmitted = true; // ÂõûÁ≠îÈÄÅ‰ø°„Éï„É©„Ç∞„ÇíË®≠ÂÆö
    
    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    const submitBtns = document.querySelectorAll('.submit-btn');
    submitBtns.forEach(btn => btn.disabled = true);
    
    if(state.mode === 'formula'){
        submitFormulaAnswer();
    }else{
        submitNormalAnswer();
    }
}

function submitNormalAnswer(){
    const input=$("norm").value.trim();
    if(!input){
        alert('Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        state.answerSubmitted = false; // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
        const submitBtns = document.querySelectorAll('.submit-btn');
        submitBtns.forEach(btn => btn.disabled = false);
        return;
    }
    
    const userAnswer=parseFloat(input);
    if(isNaN(userAnswer)){
        alert('Ê≠£„Åó„ÅÑÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        state.answerSubmitted = false; // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
        const submitBtns = document.querySelectorAll('.submit-btn');
        submitBtns.forEach(btn => btn.disabled = false);
        return;
    }
    
    const correctAnswer=state.prob.answer;
    
    if(Math.abs(userAnswer-correctAnswer)<0.001){
        handleCorrect();
    }else{
        handleWrong(correctAnswer.toString());
    }
}

function submitFormulaAnswer(){
    const num1=$("num1").value.trim();
    const operator=$("operator").value;
    const num2=$("num2").value.trim();
    
    if(!num1 || !operator || !num2){
        alert('„Åô„Åπ„Å¶„ÅÆÊ¨Ñ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        state.answerSubmitted = false; // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
        const submitBtns = document.querySelectorAll('.submit-btn');
        submitBtns.forEach(btn => btn.disabled = false);
        return;
    }
    
    const userFormula = `${num1}${operator}${num2}`;
    const correctFormula = state.prob.formula;
    
    if(userFormula === correctFormula){
        handleCorrect();
    }else{
        handleWrong(correctFormula);
    }
}

// handleCorrectÈñ¢Êï∞„Çí‰øÆÊ≠£ÔºàÁ´∂ÂêàÂõûÈÅøÁâàÔºâ
async function handleCorrect(){
    state.score++;
    $("score").textContent=state.score;
    
    const points=calculateCorrectPoints(state.level,state.mode);
    await addPoints(points);
    
    $("monster").classList.add("correct");
    setTimeout(()=>$("monster").classList.remove("correct"),1500);
    
    if(state.mode==='practice'){
        state.lvCount++;
        if(state.lvCount>=5){
            state.completed.add(state.level);
            const levelPoints=calculateLevelPoints(state.level,state.mode);
            await addPoints(levelPoints);
            
            $("monster").classList.add("level-up");
            setTimeout(()=>$("monster").classList.remove("level-up"),3000);
            
            if(state.level<5){
                state.level++;
                state.lvCount=0;
            }else{
                setTimeout(()=>{
                    alert('Á∑¥Áøí„É¢„Éº„ÉâÂÖ®„É¨„Éô„É´ÂÆå‰∫ÜÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                    backToStart();
                },2000);
                return;
            }
        }
    }else if(state.mode==='summary'){
        state.totalQ++;
        
        // „Åæ„Å®„ÇÅ„É¢„Éº„Éâ„Åß„É¨„Éô„É´„ÇØ„É™„Ç¢ÊôÇ„Å´„Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÇíË°®Á§∫
        if(state.totalQ % 5 === 0 && state.totalQ < 25) {
            // „É¨„Éô„É´„ÇØ„É™„Ç¢ÊôÇ„ÅÆÂá¶ÁêÜ
            pendingLevelUp = true; // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂæÖÊ©ü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            
            // „Éú„Éº„Éä„Çπ„Ç≤„Éº„É†„ÇíË°®Á§∫
            setTimeout(() => {
                showBonusGame();
            }, 1500);
            return; // „Åì„Åì„ÅßÂá¶ÁêÜ„ÇíÂÅúÊ≠¢„Åó„ÄÅ„Éú„Éº„Éä„Çπ„Ç≤„Éº„É†Âæå„Å´Á∂öË°å
        } else if(state.totalQ>=25){
            stopTimer();
            const clearTime=getElapsedTime();
            enableHiddenStage();
            setTimeout(()=>showClear(clearTime),1000);
            return;
        } else if(state.totalQ%5===0){
            // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ„ÇíËøΩÂä†
            state.level++;
        }
    }else if(state.mode==='hidden'){
        state.hiddenQ++;
        if(state.hiddenQ>=10){
            stopTimer();
            setTimeout(()=>showHiddenClear(),1000);
            return;
        }
    }else if(state.mode==='select'){
        state.selectQCount++;
        state.selectCorrectCount++;
        
        if(state.selectCorrectCount>=10){
            state.clearedLevels.add(state.level);
            saveClearedLevels();
            
            const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
            await addPoints(levelClearPoints);
            
            setTimeout(()=>showLevelClear(),1000);
            return;
        }
    }else if(state.mode==='formula'){
        state.formulaCorrectCount++;
        
        if(state.formulaCorrectCount>=10){
            state.clearedLevels.add(state.level);
            saveClearedLevels();
            
            const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
            await addPoints(levelClearPoints);
            
            setTimeout(()=>showFormulaLevelClear(),1000);
            return;
        }
    }
    
    updateLevelIndicator();
    updateProgressBar();
    setTimeout(newProblem,1500);
}

function handleWrong(correctAnswer){
    $("correctAnswer").style.display="block";
    $("correctText").textContent=correctAnswer;
    
    if(state.mode==='practice'){
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("formulaMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
        $("backToFormulaSelectBtn").style.display="none";
        state.lvCount=0;
    }else if(state.mode==='summary'||state.mode==='hidden'){
        stopTimer();
        const finalTime=getElapsedTime();
        setTimeout(()=>showGameOver(finalTime),2000);
        return;
    }else if(state.mode==='select'){
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("formulaMsg").style.display="none";
        $("backToSelectBtn").style.display="inline-block";
        $("backToFormulaSelectBtn").style.display="none";
        state.selectCorrectCount=0;
    }else if(state.mode==='formula'){
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="none";
        $("formulaMsg").style.display="block";
        $("backToSelectBtn").style.display="none";
        $("backToFormulaSelectBtn").style.display="inline-block";
        state.formulaCorrectCount=0;
    }
    
    $("monster").classList.add("wrong");
    setTimeout(()=>$("monster").classList.remove("wrong"),1000);
    $("wrong").style.display="block";
    updateProgressBar();
}

function retry(){
    $("wrong").style.display="none";
    newProblem();
}

function next(){
    $("wrong").style.display="none";
    newProblem();
}

async function showGameOver(finalTime){
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(finalTime);
        
        if(state.score > 0){
            const gameoverPoints=state.level*20;
            $("gameoverPoints").style.display="block";
            $("gameoverPointsValue").textContent=gameoverPoints;
            await addPoints(gameoverPoints);
        }
        
        displayGlobalRanking('#globalRankingGameover','#myGlobalRankGameover');
    }
}

async function showClear(clearTime){
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    $("clearTimeValue").textContent=formatTime(clearTime);
    
    const clearPoints=calculateClearPoints(clearTime);
    $("pointsEarned").style.display="block";
    $("earnedPoints").textContent=clearPoints;
    await addPoints(clearPoints);
    
    try{localStorage.setItem('summaryCleared','true')}catch(e){}
    
    createFireworks();
    displayGlobalRanking('#globalRankingClear','#myGlobalRankClear');
    
    $("hiddenStageUnlock").style.display="block";
}

async function showLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    
    const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
    $("levelClearPointsValue").textContent=levelClearPoints;
    
    $("backToFormulaSelectFromClear").style.display="none";
    
    createFireworks();
}

async function showFormulaLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    
    const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
    $("levelClearPointsValue").textContent=levelClearPoints;
    
    $("backToFormulaSelectFromClear").style.display="inline-block";
    
    createFireworks();
}

async function showHiddenClear(){
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    createMasterFireworks();
    unlockTitle('decimalMaster');
    
    const hiddenPoints=3000;
    $("hiddenPointsEarned").style.display="block";
    $("hiddenEarnedPoints").textContent=hiddenPoints;
    await addPoints(hiddenPoints);
    
    displayGlobalRanking('#globalRankingHidden','#myGlobalRankHidden');
}

function restart(){
    state.sessionPoints=0;
    backToStart();
}

function createFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<20;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*2+"s";
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),3000);
    }
    
    for(let i=0;i<50;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*3+"s";
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),4000);
    }
}

function createMasterFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<50;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*3+"s";
        firework.style.background=`hsl(${Math.random()*360},100%,50%)`;
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),5000);
    }
    
    for(let i=0;i<100;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*5+"s";
        sparkle.style.background=`hsl(${Math.random()*360},100%,70%)`;
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),6000);
    }
}

function unlockTitle(titleKey){
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try{localStorage.setItem('titles',JSON.stringify(titles))}catch(e){}
    }
}

// Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅÆËß£ÊîæÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
try{
    if(localStorage.getItem('summaryCleared')==='true'){
        enableHiddenStage();
    }
}catch(e){}

// Enter„Ç≠„Éº„Åß„ÅÆÂõûÁ≠îÈÄÅ‰ø°
document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&$("game").style.display==="block"&&!state.answerSubmitted){
        if(state.mode === 'formula'){
            // Âºè„Å†„Åë„É¢„Éº„Éâ„Åß„ÅØ„ÄÅÊúÄÂæå„ÅÆÂÖ•ÂäõÊ¨Ñ„Åã„ÇâEnter„ÅßÈÄÅ‰ø°
            if(document.activeElement === $("num2") && $("num1").value && $("operator").value && $("num2").value){
                submitAnswer();
            }
        }else if(state.mode !== 'formula' && $("norm").value){
            submitAnswer();
        }
    }
});

// ÊâãÊõ∏„ÅçÊèèÁîªÊ©üËÉΩ„ÅÆÂ§âÊï∞ÔºàÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Å¶Á´∂Âêà„ÇíÂõûÈÅøÔºâ
let drawCanvas, drawCtx, isDrawingNow = false;

// ÊâãÊõ∏„Åç„Çπ„Éö„Éº„Çπ„ÅÆÂàùÊúüÂåñ
function initDrawingSpace() {
  drawCanvas = document.getElementById('drawArea');
  if (!drawCanvas) {
    console.log('Canvas element not found');
    return;
  }
  
  drawCtx = drawCanvas.getContext('2d');
  if (!drawCtx) {
    console.log('Canvas context not available');
    return;
  }
  
  // CanvasË®≠ÂÆö„ÇíÊòéÁ§∫ÁöÑ„Å´Ë®≠ÂÆö
  drawCtx.lineCap = 'round';
  drawCtx.lineJoin = 'round';
  drawCtx.lineWidth = 2;
  drawCtx.strokeStyle = '#2196f3';
  
  console.log('Drawing space initialized');
  setupDrawingEvents();
}

function getDrawPos(e) {
  const rect = drawCanvas.getBoundingClientRect();
  
  if (e.touches && e.touches.length > 0) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  } else {
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }
}

function setupDrawingEvents() {
  if (!drawCanvas || !drawCtx) {
    console.log('Canvas or context not available for event setup');
    return;
  }
  
  console.log('Setting up drawing events');
  
  // „Éû„Ç¶„ÇπÊìç‰Ωú
  drawCanvas.addEventListener('mousedown', function(e) {
    console.log('Mouse down');
    isDrawingNow = true;
    const pos = getDrawPos(e);
    drawCtx.beginPath();
    drawCtx.moveTo(pos.x, pos.y);
    e.preventDefault();
  });
  
  drawCanvas.addEventListener('mousemove', function(e) {
    if (!isDrawingNow) return;
    console.log('Mouse move - drawing');
    const pos = getDrawPos(e);
    drawCtx.lineTo(pos.x, pos.y);
    drawCtx.stroke();
    e.preventDefault();
  });
  
  drawCanvas.addEventListener('mouseup', function(e) {
    console.log('Mouse up');
    isDrawingNow = false;
    drawCtx.beginPath();
    e.preventDefault();
  });
  
  drawCanvas.addEventListener('mouseleave', function(e) {
    isDrawingNow = false;
    drawCtx.beginPath();
  });

  // „Çø„ÉÉ„ÉÅÊìç‰ΩúÔºà„Çπ„Éû„Éõ„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøúÔºâ
  drawCanvas.addEventListener('touchstart', function(e) {
    console.log('Touch start');
    e.preventDefault();
    isDrawingNow = true;
    const pos = getDrawPos(e);
    drawCtx.beginPath();
    drawCtx.moveTo(pos.x, pos.y);
  }, { passive: false });
  
  drawCanvas.addEventListener('touchmove', function(e) {
    if (!isDrawingNow) return;
    console.log('Touch move - drawing');
    e.preventDefault();
    const pos = getDrawPos(e);
    drawCtx.lineTo(pos.x, pos.y);
    drawCtx.stroke();
  }, { passive: false });
  
  drawCanvas.addEventListener('touchend', function(e) {
    console.log('Touch end');
    e.preventDefault();
    isDrawingNow = false;
    drawCtx.beginPath();
  }, { passive: false });
  
  drawCanvas.addEventListener('touchcancel', function(e) {
    e.preventDefault();
    isDrawingNow = false;
    drawCtx.beginPath();
  }, { passive: false });
}

function clearDrawCanvas() {
  if (!drawCtx || !drawCanvas) {
    console.log('Canvas or context not available for clearing');
    return;
  }
  console.log('Clearing canvas');
  drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÊâãÊõ∏„Åç„Çπ„Éö„Éº„Çπ„ÇíÂàùÊúüÂåñ
window.addEventListener('load', function() {
  console.log('Page loaded, initializing drawing space');
  // Êó¢Â≠ò„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ„ÅÆÂæå„Å´ÊâãÊõ∏„Åç„Çπ„Éö„Éº„Çπ„ÇíÂàùÊúüÂåñ
  setTimeout(function() {
    initDrawingSpace();
  }, 1000); // 1ÁßíÂæå„Å´ÂàùÊúüÂåñ
});

// ÊâãÂãïÂàùÊúüÂåñÁî®„ÅÆÈñ¢Êï∞Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
function manualInitDraw() {
  console.log('Manual initialization');
  initDrawingSpace();
}
</script>
</body>
</html>
