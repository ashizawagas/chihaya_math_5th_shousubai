<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 5å¹´ç”Ÿå°æ•°ç‰ˆ</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
.monster.super-clear{animation:superClear 4s}

@keyframes levelUp{
  0%{transform:scale(1)}
  20%{transform:scale(2)rotate(180deg);color:#ff0}
  40%{transform:scale(3)rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}
  60%{transform:scale(2.5)rotate(540deg);color:#ff69b4;filter:drop-shadow(0 0 30px #ff69b4)}
  80%{transform:scale(3.5)rotate(720deg);color:#00ff00;filter:drop-shadow(0 0 40px #00ff00)}
  100%{transform:scale(1)rotate(900deg);color:gold}
}

@keyframes correct{
  0%{transform:scale(1)}
  25%{transform:scale(1.4)rotate(15deg);color:#0f0;filter:drop-shadow(0 0 10px #0f0)}
  50%{transform:scale(1.6)rotate(-15deg);color:#00ff00;filter:drop-shadow(0 0 15px #00ff00)}
  75%{transform:scale(1.3)rotate(10deg);color:#32cd32}
  100%{transform:scale(1);color:gold}
}

@keyframes wrong{
  0%{transform:scale(1)}
  25%{transform:scale(1.2)rotate(-10deg);color:#f00}
  50%{transform:scale(1.2)rotate(10deg);color:#f00}
  75%{transform:scale(1.2)rotate(-10deg);color:#f00}
  100%{transform:scale(1);color:#333}
}

@keyframes superClear{
  0%{transform:scale(1)rotate(0deg);color:gold}
  10%{transform:scale(4)rotate(180deg);color:#ff0;filter:drop-shadow(0 0 50px #ff0)}
  20%{transform:scale(5)rotate(360deg);color:#ff69b4;filter:drop-shadow(0 0 60px #ff69b4)}
  30%{transform:scale(6)rotate(540deg);color:#00ff00;filter:drop-shadow(0 0 70px #00ff00)}
  40%{transform:scale(7)rotate(720deg);color:#00bfff;filter:drop-shadow(0 0 80px #00bfff)}
  50%{transform:scale(8)rotate(900deg);color:#ff4500;filter:drop-shadow(0 0 90px #ff4500)}
  60%{transform:scale(7)rotate(1080deg);color:#9370db;filter:drop-shadow(0 0 80px #9370db)}
  70%{transform:scale(6)rotate(1260deg);color:#ffd700;filter:drop-shadow(0 0 70px #ffd700)}
  80%{transform:scale(5)rotate(1440deg);color:#ff1493;filter:drop-shadow(0 0 60px #ff1493)}
  90%{transform:scale(4)rotate(1620deg);color:#00ff7f;filter:drop-shadow(0 0 50px #00ff7f)}
  100%{transform:scale(1)rotate(1800deg);color:gold}
}

.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.back-to-top{position:fixed;top:20px;right:20px;background:#f44336;z-index:1000}
.back-to-top:hover{background:#d32f2f}
.timer{font-size:24px;font-weight:bold;color:#2196f3;margin:10px 0}
.level-select{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.level-btn{background:#4caf50;padding:20px;font-size:18px;min-width:150px}
.level-btn:hover{background:#45a049}
.ranking{background:white;border-radius:10px;padding:20px;margin:20px 0;text-align:left}
.ranking h3{text-align:center;color:#2196f3}
.rank-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee}
.rank-item:last-child{border-bottom:none}
.rank-medal{font-size:20px;margin-right:10px}

input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
select{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px;background:white}
select:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:200px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:120px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.equation-input{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.equation-input input{width:80px;text-align:center}
.equation-input select{width:80px;text-align:center}
.equation-part{font-size:18px;font-weight:bold;color:#333}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.story-problem{background:#f5f5f5;padding:15px;border-left:4px solid #2196f3;margin:10px 0;text-align:left;line-height:1.6}
.calculation-problem{background:#f8f9fa;padding:20px;border-radius:10px;margin:15px 0;font-size:28px;font-weight:bold;color:#333}
</style>
</head>
<body>
<h1>ğŸ§® åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 5å¹´ç”Ÿå°æ•°ç‰ˆ</h1>

<div id="start">
<h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="info">
<div class="mode-info select">
<h3>ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å¥½ããªãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§10å•ç·´ç¿’<br>â€¢ é–“é•ãˆã¦ã‚‚ç¶šè¡Œå¯èƒ½</p>
</div>
<div class="mode-info practice">
<h3>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å„ãƒ¬ãƒ™ãƒ«ã§5å•é€£ç¶šæ­£è§£ã§æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸<br>â€¢ é–“é•ãˆãŸã‚‰ãã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚‹</p>
</div>
<div class="mode-info summary">
<h3>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å…¨4ãƒ¬ãƒ™ãƒ«Ã—å„5å•ï¼è¨ˆ20å•ã«æŒ‘æˆ¦<br>â€¢ ä¸€å•ã§ã‚‚é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>â€¢ ã‚¿ã‚¤ãƒãƒ¼ä»˜ãã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨˜éŒ²</p>
</div>
</div>
<button class="mode-btn select" onclick="selectMode('select')">é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn practice" onclick="selectMode('practice')">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn" onclick="selectMode('summary')">ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<div id="levelSelect" style="display:none">
<h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="level-select">
<button class="level-btn" onclick="startSelectMode(1)">ãƒ¬ãƒ™ãƒ«1<br>ã‹ã‘ç®—ã®ç«‹å¼</button>
<button class="level-btn" onclick="startSelectMode(2)">ãƒ¬ãƒ™ãƒ«2<br>å‰²ã‚Šç®—ã®ç«‹å¼</button>
<button class="level-btn" onclick="startSelectMode(3)">ãƒ¬ãƒ™ãƒ«3<br>å°æ•°ã®ã‹ã‘ç®—</button>
<button class="level-btn" onclick="startSelectMode(4)">ãƒ¬ãƒ™ãƒ«4<br>å°æ•°ã®å‰²ã‚Šç®—</button>
</div>
<button onclick="backToStart()">æˆ»ã‚‹</button>
</div>

<div id="game" style="display:none">
<button class="back-to-top" onclick="backToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹</button>
<div class="info">
<div id="modeDisplay"></div>
<div>ãƒ¬ãƒ™ãƒ«<span id="lv">1</span>/4 - <span id="lvInfo"></span></div>
<div id="timerDisplay" class="timer" style="display:none">â±ï¸ <span id="timer">00:00</span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">ğŸ“</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
<div class="normal-input">
<input type="text" id="answer" placeholder="ç­”ãˆã‚’å…¥åŠ›">
<div id="answerUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitAnswer()">ç­”ãˆã‚‹</button>
</div>
</div>

<div id="equationSection" class="answer-section" style="display:none">
<h3>å¼ã‚’ä½œã£ã¦ãã ã•ã„ï¼ˆç­”ãˆã¯è¨ˆç®—ã—ã¾ã›ã‚“ï¼‰</h3>
<div class="equation-input">
<input type="text" id="num1" placeholder="æ•°1">
<select id="operator">
<option value="">é¸æŠ</option>
<option value="Ã—">Ã—</option>
<option value="Ã·">Ã·</option>
</select>
<input type="text" id="num2" placeholder="æ•°2">
</div>
<button class="submit-btn" onclick="submitEquation()">å¼ã‚’ç­”ãˆã‚‹</button>
</div>

<div id="wrong" style="display:none">
<div id="wrongMsg" class="error-msg">ã¾ã¡ãŒã„ã§ã™ã€‚</div>
<div id="correctAnswer" class="correct-answer" style="display:none">
<strong>æ­£è§£ï¼š</strong><span id="correctText"></span>
</div>
<div id="practiceMsg" style="display:none"><p>ã“ã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚Šã¾ã™ã€‚é ‘å¼µã£ã¦ï¼</p></div>
<button onclick="retry()">ã‚‚ã†ä¸€åº¦</button>
<button onclick="next()">ã¤ãã¸</button>
</div>

<div class="status">
<span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 20å•ä¸­</span>
<span id="selectQ" style="display:none"> / 10å•ä¸­</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
<div class="monster" style="font-size:120px">ğŸ˜µ</div>
<h2>æ®‹å¿µï¼</h2>
<div class="info">
<p>åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="finalLv"></span>/4</p>
<p>æ­£è§£æ•°: <span id="finalScore1"></span>å•</p>
<p>ã‚¿ã‚¤ãƒ : <span id="finalTime"></span></p>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ‘‘</div>
<h2>ãŠã‚ã§ã¨ã†ï¼å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼</h2>
<div class="info">
<div>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore2"></span>å•æ­£è§£</div>
<div id="clearTime" style="display:none">ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ : <span id="finalClearTime"></span></div>
<div id="ranking" class="ranking" style="display:none">
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="rankingList"></div>
</div>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<script>
const $ = id => document.getElementById(id);
let state = {score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),startTime:null,selectLevel:1};
const monsters = ["ğŸ“","ğŸ”","ğŸ”¢","â—"];
const lvNames = ["ã‹ã‘ç®—ã®ç«‹å¼","å‰²ã‚Šç®—ã®ç«‹å¼","å°æ•°ã®ã‹ã‘ç®—","å°æ•°ã®å‰²ã‚Šç®—"];

const R = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
const randomDecimal = (min, max, places = 1) => {
    const num = Math.random() * (max - min) + min;
    return Math.round(num * Math.pow(10, places)) / Math.pow(10, places);
};

function setFocus(){
    setTimeout(()=>{
        const input = state.prob?.type === 'equation' ? $("num1") : $("answer");
        if(input) input.focus();
    }, 150);
}

document.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && e.target.tagName==='INPUT'){
        e.preventDefault();
        if(['num1','num2'].includes(e.target.id)) submitEquation();
        else if(e.target.id==='answer') submitAnswer();
    }
});

function selectMode(m){
    if(m === 'select'){
        $("start").style.display="none";
        $("levelSelect").style.display="block";
        return;
    }
    
    state={score:0,level:1,prob:null,unit:"",mode:m,lvCount:0,totalQ:0,qNum:0,completed:new Set(),startTime:null,selectLevel:1};
    $("start").style.display="none";
    $("game").style.display="block";
    
    if(m === 'summary'){
        state.startTime = Date.now();
        $("timerDisplay").style.display="block";
        startTimer();
    }
    
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function startSelectMode(level){
    state={score:0,level:level,prob:null,unit:"",mode:'select',lvCount:0,totalQ:0,qNum:0,completed:new Set(),startTime:null,selectLevel:level};
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function backToStart(){
    $("levelSelect").style.display="none";
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("start").style.display="block";
    if(state.timerInterval) clearInterval(state.timerInterval);
    state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),startTime:null,selectLevel:1};
}

function startTimer(){
    state.timerInterval = setInterval(()=>{
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        $("timer").textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    }, 1000);
}

function updateDisplay(){
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[state.level-1];
    $("score").textContent=state.score;
    $("monster").textContent=monsters[state.level-1];

    const bar=$("progressBar");
    if(state.mode==='practice'){
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`ã“ã®ãƒ¬ãƒ™ãƒ«: ${state.lvCount}/5å•æ­£è§£`;
        bar.className="progress-bar practice";
        bar.style.width=`${(state.lvCount/5)*100}%`;
        $("totalQ").style.display="none";
        $("selectQ").style.display="none";
    }else if(state.mode==='summary'){
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`å•é¡Œ ${state.totalQ+1}/20`;
        bar.className="progress-bar summary";
        bar.style.width=`${(state.totalQ/20)*100}%`;
        $("totalQ").style.display="inline";
        $("totalQ").textContent=" / 20å•ä¸­";
        $("selectQ").style.display="none";
    }else if(state.mode==='select'){
        $("modeDisplay").innerHTML='<div class="mode-info select"><strong>ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`å•é¡Œ ${state.totalQ+1}/10`;
        bar.className="progress-bar select";
        bar.style.width=`${(state.totalQ/10)*100}%`;
        $("totalQ").style.display="none";
        $("selectQ").style.display="inline";
        $("selectQ").textContent=" / 10å•ä¸­";
    }
}

function updateLevelIndicator(){
    const ind=$("levelIndicator");
    ind.innerHTML="";
    if(state.mode === 'select'){
        const dot=document.createElement("div");
        dot.className="level-dot current";
        dot.textContent=state.selectLevel;
        ind.appendChild(dot);
    }else{
        for(let i=1;i<=4;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            dot.textContent=i;
            if(state.completed.has(i))dot.classList.add("completed");
            else if(i===state.level)dot.classList.add("current");
            ind.appendChild(dot);
        }
    }
}

function generateProblem(lv){
    switch(lv){
        case 1:{ // ã‹ã‘ç®—ã®æ–‡ç« é¡Œï¼ˆç«‹å¼ã®ã¿ï¼‰
            const baseNum = randomDecimal(2, 8, 1);
            const multiplier = randomDecimal(2, 5, 1);
            
            const stories = [
                [`èµ¤ã„ãƒªãƒœãƒ³ã®é•·ã•ã¯${baseNum}mã§ã™ã€‚é’ã„ãƒªãƒœãƒ³ã¯èµ¤ã„ãƒªãƒœãƒ³ã®${multiplier}å€ã®é•·ã•ã§ã™ã€‚`, "é’ã„ãƒªãƒœãƒ³ã®é•·ã•ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                [`1å€‹${baseNum}å††ã®ã‚Šã‚“ã”ã‚’${multiplier}å€‹è²·ã„ã¾ã—ãŸã€‚`, "ã‚Šã‚“ã”ã®ä»£é‡‘ã®åˆè¨ˆã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                [`æ°´æ§½ã«${baseNum}Lã®æ°´ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«${multiplier}å€ã®æ°´ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, "æ°´æ§½ã®æ°´ã®åˆè¨ˆã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                [`1mã®é‡ã•ãŒ${baseNum}kgã®é‰„ã®ãƒ‘ã‚¤ãƒ—ãŒã‚ã‚Šã¾ã™ã€‚`, `${multiplier}mã®ãƒ‘ã‚¤ãƒ—ã®é‡ã•ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚`],
                [`èŠ±å­ã•ã‚“ã¯1æ—¥ã«${baseNum}ãƒšãƒ¼ã‚¸ã®æœ¬ã‚’èª­ã¿ã¾ã™ã€‚`, `${multiplier}æ—¥é–“ã§èª­ã‚€ãƒšãƒ¼ã‚¸æ•°ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚`],
                [`1ã¤ã®ç®±ã«${baseNum}å€‹ã®ãƒœãƒ¼ãƒ«ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚`, `${multiplier}ã¤ã®ç®±ã®ãƒœãƒ¼ãƒ«ã®åˆè¨ˆã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚`]
            ];
            
            const story = stories[R(0, stories.length-1)];
            
            return {
                q: `<div class="story-problem">${story[0]}<br><strong>${story[1]}</strong></div>`,
                type: 'equation',
                num1: baseNum,
                operator: 'Ã—',
                num2: multiplier
            };
        }
        
        case 2:{ // å‰²ã‚Šç®—ã®æ–‡ç« é¡Œï¼ˆç«‹å¼ã®ã¿ï¼‰
            const problemTypes = [
                // ä½•å€ã‹ã‚’æ±‚ã‚ã‚‹å•é¡Œ
                () => {
                    const base = randomDecimal(1.5, 6.0, 1);
                    const multiplied = randomDecimal(4.0, 18.0, 1);
                    
                    const stories = [
                        [`å¤ªéƒãã‚“ã®èº«é•·ã¯${base}mã§ã™ã€‚`, `èŠ±å­ã•ã‚“ã®èº«é•·ã¯${multiplied}mã§ã™ã€‚`, "èŠ±å­ã•ã‚“ã®èº«é•·ãŒå¤ªéƒãã‚“ã®ä½•å€ã‹ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`1æœ¬${base}å††ã®é‰›ç­†ãŒã‚ã‚Šã¾ã™ã€‚`, `ãƒšãƒ³ã®å€¤æ®µã¯${multiplied}å††ã§ã™ã€‚`, "ãƒšãƒ³ã®å€¤æ®µãŒé‰›ç­†ã®ä½•å€ã‹ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`ç®±Aã«ã¯${base}kgã®ç±³ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚`, `ç®±Bã«ã¯${multiplied}kgã®ç±³ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚`, "ç®±Bã®ç±³ã®é‡ã•ãŒç®±Aã®ä½•å€ã‹ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`å¤ªéƒãã‚“ã¯${base}åˆ†ã§å®¿é¡Œã‚’çµ‚ã‚ã‚‰ã›ã¾ã™ã€‚`, `èŠ±å­ã•ã‚“ã¯${multiplied}åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚`, "èŠ±å­ã•ã‚“ã®æ™‚é–“ãŒå¤ªéƒãã‚“ã®ä½•å€ã‹ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"]
                    ];
                    
                    const story = stories[R(0, stories.length-1)];
                    return {
                        story1: story[0],
                        story2: story[1],
                        question: story[2],
                        num1: multiplied,
                        operator: 'Ã·',
                        num2: base
                    };
                },
                // ç­‰åˆ†ã®å•é¡Œ
                () => {
                    const total = randomDecimal(6.0, 20.0, 1);
                    const parts = R(2, 5);
                    
                    const stories = [
                        [`${total}mã®ãƒ­ãƒ¼ãƒ—ã‚’${parts}ç­‰åˆ†ã—ã¾ã™ã€‚`, "1æœ¬åˆ†ã®é•·ã•ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`${total}Lã®ã‚¸ãƒ¥ãƒ¼ã‚¹ã‚’${parts}äººã§ç­‰ã—ãåˆ†ã‘ã¾ã™ã€‚`, "1äººåˆ†ã®é‡ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`${total}kgã®ãŠç±³ã‚’${parts}ã¤ã®è¢‹ã«ç­‰ã—ãåˆ†ã‘ã¾ã™ã€‚`, "1è¢‹ã‚ãŸã‚Šã®é‡ã•ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`${total}å††ã‚’${parts}äººã§ç­‰ã—ãåˆ†ã‘ã¾ã™ã€‚`, "1äººåˆ†ã®é‡‘é¡ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"],
                        [`${total}å€‹ã®ã‚ã‚ã‚’${parts}äººã§ç­‰ã—ãåˆ†ã‘ã¾ã™ã€‚`, "1äººåˆ†ã®å€‹æ•°ã‚’æ±‚ã‚ã‚‹å¼ã‚’ä½œã£ã¦ãã ã•ã„ã€‚"]
                    ];
                    
                    const story = stories[R(0, stories.length-1)];
                    return {
                        story1: story[0],
                        story2: "",
                        question: story[1],
                        num1: total,
                        operator: 'Ã·',
                        num2: parts
                    };
                }
            ];
            
            const problemData = problemTypes[R(0, problemTypes.length-1)]();
            
            const storyText = problemData.story2 ? 
                `${problemData.story1}<br>${problemData.story2}` : 
                problemData.story1;
            
            return {
                q: `<div class="story-problem">${storyText}<br><strong>${problemData.question}</strong></div>`,
                type: 'equation',
                num1: problemData.num1,
                operator: problemData.operator,
                num2: problemData.num2
            };
        }
        
        case 3:{ // å°æ•°ã®ã‹ã‘ç®—è¨ˆç®—å•é¡Œ
            const problemTypes = [
                // å°æ•° Ã— æ•´æ•°
                () => {
                    const decimal = randomDecimal(1.1, 9.9, 1);
                    const integer = R(2, 9);
                    const result = Math.round(decimal * integer * 10) / 10;
                    return {
                        num1: decimal,
                        num2: integer,
                        result: result
                    };
                },
                // å°æ•° Ã— å°æ•°ï¼ˆå°æ•°ç¬¬1ä½åŒå£«ï¼‰
                () => {
                    const decimal1 = randomDecimal(1.1, 5.9, 1);
                    const decimal2 = randomDecimal(1.1, 4.9, 1);
                    const result = Math.round(decimal1 * decimal2 * 100) / 100;
                    return {
                        num1: decimal1,
                        num2: decimal2,
                        result: result
                    };
                },
                // æ•´æ•° Ã— å°æ•°
                () => {
                    const integer = R(2, 8);
                    const decimal = randomDecimal(1.2, 6.8, 1);
                    const result = Math.round(integer * decimal * 10) / 10;
                    return {
                        num1: integer,
                        num2: decimal,
                        result: result
                    };
                }
            ];
            
            const problemData = problemTypes[R(0, problemTypes.length-1)]();
            
            return {
                q: `<div class="calculation-problem">${problemData.num1} Ã— ${problemData.num2} =</div>`,
                type: 'answer',
                answer: problemData.result,
                unit: ""
            };
        }
        
        case 4:{ // å°æ•°ã®å‰²ã‚Šç®—è¨ˆç®—å•é¡Œï¼ˆå°æ•°ç¬¬2ä½ã¾ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ï¼‰
            const problemTypes = [
                // å°æ•° Ã· æ•´æ•°ï¼ˆå‰²ã‚Šåˆ‡ã‚Œã‚‹ï¼‰
                () => {
                    const divisors = [2, 4, 5, 8, 10];
                    const divisor = divisors[R(0, divisors.length-1)];
                    const result = randomDecimal(0.5, 9.9, 1);
                    const dividend = Math.round(result * divisor * 10) / 10;
                    return {
                        num1: dividend,
                        num2: divisor,
                        result: result
                    };
                },
                // æ•´æ•° Ã· å°æ•°ï¼ˆçµæœãŒå‰²ã‚Šåˆ‡ã‚Œã‚‹ï¼‰
                () => {
                    const decimals = [0.5, 1.25, 2.5, 4];
                    const divisor = decimals[R(0, decimals.length-1)];
                    const result = R(2, 12);
                    const dividend = result * divisor;
                    return {
                        num1: dividend,
                        num2: divisor,
                        result: result
                    };
                },
                // å°æ•° Ã· å°æ•°ï¼ˆçµæœãŒå°æ•°ç¬¬2ä½ã¾ã§ï¼‰
                () => {
                    const divisors = [0.5, 1.25, 2.5];
                    const divisor = divisors[R(0, divisors.length-1)];
                    const results = [0.4, 0.8, 1.2, 1.6, 2.4, 3.2, 4.8];
                    const result = results[R(0, results.length-1)];
                    const dividend = Math.round(result * divisor * 100) / 100;
                    return {
                        num1: dividend,
                        num2: divisor,
                        result: result
                    };
                }
            ];
            
            const problemData = problemTypes[R(0, problemTypes.length-1)]();
            
            return {
                q: `<div class="calculation-problem">${problemData.num1} Ã· ${problemData.num2} =</div>`,
                type: 'answer',
                answer: problemData.result,
                unit: ""
            };
        }
    }
}

function nextQ(){
    if(state.mode==='practice'){
        if(state.lvCount>=5){
            state.completed.add(state.level);
            if(state.level>=4){showClear();return;}
            state.level++;
            state.lvCount=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }else if(state.mode==='summary'){
        if(state.level>=4&&state.qNum>=5){showClear();return;}
        if(state.qNum>=5){
            state.completed.add(state.level);
            state.level++;
            state.qNum=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }else if(state.mode==='select'){
        if(state.totalQ>=10){showClear();return;}
    }

    state.prob=generateProblem(state.level);
    $("q").innerHTML=state.prob.q;
    state.unit=state.prob.unit||"";

    clearInputs();
    $("wrong").style.display="none";

    if(state.prob.type==='equation'){
        $("answerSections").style.display="none";
        $("equationSection").style.display="block";
    }else{
        $("answerSections").style.display="flex";
        $("equationSection").style.display="none";
    }

    $("answerUnit").textContent=state.unit;
    $("answerUnit").style.display=state.unit?"block":"none";

    updateDisplay();
    setFocus();
}

function clearInputs(){
    ["answer","num1","num2"].forEach(id=>$(id).value="");
    $("operator").value="";
}

function animate(cls){
    $("monster").classList.add(cls);
    setTimeout(()=>$("monster").classList.remove(cls),cls==="level-up"?3000:cls==="super-clear"?4000:1500);
}

function submitAnswer(){
    const userInput = $("answer").value.trim();
    if(!userInput){showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    
    const userAnswer = parseFloat(userInput);
    const correctAnswer = state.prob.answer;
    
    if(isNaN(userAnswer)){showError("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    
    const tolerance = 0.01;
    const isCorrect = Math.abs(userAnswer - correctAnswer) < tolerance;
    
    handleAnswer(isCorrect, correctAnswer + state.unit);
}

function submitEquation(){
    const num1 = parseFloat($("num1").value) || 0;
    const operator = $("operator").value;
    const num2 = parseFloat($("num2").value) || 0;
    
    if(num1 === 0 || !operator || num2 === 0){
        showError("ã™ã¹ã¦ã®æ¬„ã«æ•°å€¤ãƒ»è¨˜å·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const tolerance = 0.01;
    const isCorrect = Math.abs(num1 - state.prob.num1) < tolerance &&
                     operator === state.prob.operator &&
                     Math.abs(num2 - state.prob.num2) < tolerance;
    
    const correctEq = `${state.prob.num1} ${state.prob.operator} ${state.prob.num2}`;
    handleAnswer(isCorrect, correctEq);
}

function handleAnswer(isCorrect, correctAns){
    if(isCorrect){
        state.score++;
        if(state.mode==='practice')state.lvCount++;
        else if(state.mode==='summary'){state.qNum++;state.totalQ++;}
        else if(state.mode==='select')state.totalQ++;
        animate("correct");
        setTimeout(nextQ,1500);
    }else{
        $("wrong").style.display="block";
        $("correctAnswer").style.display="block";
        $("correctText").textContent=correctAns;
        
        if(state.mode==='practice'){
            state.lvCount=0;
            $("practiceMsg").style.display="block";
        }else if(state.mode==='summary'){
            showGameOver();
            return;
        }else if(state.mode==='select'){
            // é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã¯é–“é•ãˆã¦ã‚‚ç¶šè¡Œ
            $("practiceMsg").style.display="none";
        }
        animate("wrong");
    }
}

function showError(msg){
    $("wrongMsg").textContent=msg;
    $("wrong").style.display="block";
    $("correctAnswer").style.display="none";
    $("practiceMsg").style.display="none";
}

function retry(){
    $("wrong").style.display="none";
    clearInputs();
    setFocus();
}

function next(){
    nextQ();
}

function showGameOver(){
    if(state.timerInterval) clearInterval(state.timerInterval);
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    if(state.mode==='summary'){
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        $("finalTime").textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    }
}

function showClear(){
    if(state.timerInterval) clearInterval(state.timerInterval);
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    
    if(state.mode==='summary'){
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        const timeStr = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        $("finalClearTime").textContent = timeStr;
        $("clearTime").style.display="block";
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ãƒ»è¡¨ç¤º
        saveAndShowRanking(elapsed);
    }
    
    animate("super-clear");
}

function saveAndShowRanking(time){
    const rankings = JSON.parse(localStorage.getItem('mathQuestRankings') || '[]');
    const now = new Date();
    const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    
    rankings.push({
        time: time,
        score: state.score,
        date: dateStr
    });
    
    rankings.sort((a,b) => a.time - b.time);
    rankings.splice(10); // ä¸Šä½10ä½ã¾ã§ä¿å­˜
    
    localStorage.setItem('mathQuestRankings', JSON.stringify(rankings));
    
    // ç¾åœ¨ã®é †ä½ã‚’è¨ˆç®—
    const currentRank = rankings.findIndex(r => r.time === time && r.date === dateStr) + 1;
    
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
    let rankingHtml = `<div style="text-align:center;margin:10px 0;font-size:18px;color:#2196f3;">ã‚ãªãŸã®é †ä½: ${currentRank}ä½</div>`;
    
    const top3 = rankings.slice(0, 3);
    top3.forEach((record, index) => {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const minutes = Math.floor(record.time / 60000);
        const seconds = Math.floor((record.time % 60000) / 1000);
        const timeStr = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        
        rankingHtml += `
            <div class="rank-item">
                <div><span class="rank-medal">${medals[index]}</span>${index + 1}ä½</div>
                <div>${timeStr}</div>
                <div>${record.date}</div>
            </div>
        `;
    });
    
    $("rankingList").innerHTML = rankingHtml;
    $("ranking").style.display = "block";
}

function restart(){
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("start").style.display="block";
    if(state.timerInterval) clearInterval(state.timerInterval);
    state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),startTime:null,selectLevel:1};
}
</script>
</body>
</html>
